#coding:utf-8
import base64
import html
import io
import os
import pdb
import sys
from PIL import Image
import random
import sqlite3
import time
import unidecode
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as EC
from appium import webdriver
from selenium.webdriver import ActionChains
from selenium.webdriver.support.wait import WebDriverWait
import logging
from datetime import datetime
import mymodules


# ================================================================================================================
# =========================================== PREPARING LOG =======================================================


logger = logging.getLogger('Facebook_bot')
logger.setLevel(logging.INFO)
formatter = logging.Formatter('%(process)d:%(asctime)s:%(levelname)s:%(name)s:%(funcName)s:%(message)s')
file_handler = logging.FileHandler(mymodules.LoadFile('log.log'))
file_handler.setFormatter(formatter)
console_handler = logging.StreamHandler()
logger.addHandler(file_handler)
logger.addHandler(console_handler)


# ================================================================================================================
# ================================================================================================================


def ShowPictureElement(p_element):
    imagestring = p_element.screenshot_as_base64

    image_string = io.BytesIO(base64.b64decode(imagestring))
    img = Image.open(image_string)
    img.show()


def WeAreInListMembers(p_driver):
    # === Let's check if we are in a profile or if we are in a list
    
    try:
        title_members = p_driver.find_elements(By.XPATH, "//android.widget.TextView[@text='Members']")
        return True
    except:
        try:
            title_members = p_driver.find_elements(By.XPATH, "//android.widget.TextView[@text='Membres']")
            return True
        except:
            return False



# ========================================================================================================
# ==================  FUNCTION TO CHECK IF WE ARE IN PROFILE PAGE   =====================================
# ========================================================================================================
def CheckIfWeAreInProfile(p_driver, p_udid):
    try:
        logger.info(f"{p_udid}||# === We check if we are really on profile page because it can bug sometimes ===")
        photo_profile = p_driver.find_elements_by_xpath("//android.widget.ImageView[@content-desc='Photo de profil']")
        logger.info(f"{p_udid}|||PhoneBot is in profile page!")
        return True

    except:
        try:
            logger.info(f"{p_udid}|||PhoneBot didn't find the French 'Photo de profil'. Let's search for English one")
            photo_profile = p_driver.find_elements_by_xpath(
                "//android.widget.ImageView[@content-desc='Profile picture']")
            logger.info(f"{p_udid}|||PhoneBot is in profile page!")
            return True
        except:
            try:
                logger.info(
                    f"{p_udid}|||PhoneBot didn't find the English 'Profile picture' . Let's search for Viewgroup class!")
                photo_profile = p_driver.find_elements_by_xpath(
                    "//android.view.ViewGroup[@content-desc='Photo de profil']")
                logger.info(f"{p_udid}|||PhoneBot is in profile page!")
                return True
            except:
                try:
                    logger.info(
                        f"{p_udid}|||PhoneBot didn't find the French Viewgroup class 'Photo de profil'. Let's search for English one")
                    photo_profile = p_driver.find_elements_by_xpath(
                        "//android.view.ViewGroup[@content-desc='Profile picture']")
                    logger.info(f"{p_udid}|||PhoneBot is in profile page!")
                    return True
                except:
                    try:
                        logger.info(
                            f"{p_udid}|||PhoneBot didn't find the english Viewgroup class 'Photo de profil'. Let's search for 'Profile Video'")
                        photo_profile = p_driver.find_elements_by_xpath(
                            "//android.view.ViewGroup[@content-desc='Profile video']")
                        logger.info(f"{p_udid}|||PhoneBot is in profile page!")
                        return True

                    except:
                        try:
                            logger.info(
                                f"{p_udid}|||PhoneBot didn't find the english 'Profile Video'. Let's search for 'Vidéo de profil'")
                            photo_profile = p_driver.find_elements_by_xpath(
                                "//android.view.ViewGroup[@content-desc='Vidéo de profil']")
                            logger.info(f"{p_udid}|||PhoneBot is in profile page!")
                            return True
                        except:
                            logger.info(
                                f"{p_udid}|||PhoneBot didn't find any profile picture. We need to come back and skip this profile!")
                            return False


def CheckIfWeAreInGroup(p_driver, p_udid):
    # === We need to check if we are in the group or not
    # ==== The way to do that is to check if the "Search" button is present or not
    try:
        #search_in_group_button = p_driver.find_elements_by_xpath("//android.widget.ImageView[@content-desc='Rechercher']")
        #logger.info(f"{p_udid}|||PhoneBot found the French button 'Search in group'.")
        search_in_group_title = p_driver.find_elements_by_xpath("//androidx.recyclerview.widget.RecyclerView/*/*/*//android.view.ViewGroup[contains(@content-desc, 'Groupe')]")
        title_group = search_in_group_title[len(search_in_group_title)-1].get_attribute('content-desc')
        element_group_name=search_in_group_title[len(search_in_group_title)-1]
        print(f"title_group : {title_group}")
        logger.info(f"{p_udid}|||PhoneBot found the French string 'Groupe'.")
        return True,title_group,element_group_name
    except:
        try:
            logger.info(f"{p_udid}|||PhoneBot didn't find the French title. Let's search for the English one.")
            #search_in_group_button = p_driver.find_elements_by_xpath("//android.widget.ImageView[@content-desc='Search']")
            #logger.info(f"{p_udid}|||PhoneBot found the English button 'Search in group'.")
            search_in_group_title = p_driver.find_elements_by_xpath(
                "//androidx.recyclerview.widget.RecyclerView/*/*/*//android.view.ViewGroup[contains(@content-desc, 'group')]")
            logger.info(f"{p_udid}|||PhoneBot found the English string 'group'.")
            title_group = search_in_group_title[len(search_in_group_title)-1].get_attribute('content-desc')
            element_group_name = search_in_group_title[len(search_in_group_title) - 1]
            print(f"title_group : {title_group}")
            return True,title_group,element_group_name
        except:
            logger.info(
                f"{p_udid}|||PhoneBot didn't find the English button 'Search in group'. It means we are not in group.")
            return False,'',None


# ========================================================================================================
# ==================  FUNCTION TO OPEN THE FRAME TO WRITE A POST IN FACEBOOK GROUP   =====================
# ========================================================================================================
def PrepareWritingFacebookPost(driver, p_udid):
    try:
        write_something_field = driver.find_elements_by_xpath(
            "//android.view.ViewGroup[@content-desc='Écrivez quelque chose...']")
        logger.info(
            f"{p_udid}|||PhoneBot didn't found the French text field 'Write something...' with '…' smaller.:-).")
        write_something_field[0].click()
        return True
    except:
        try:
            logger.info(
                f"{p_udid}|||PhoneBot didn't find the French text field 'Ecrire quelque chose...'. Let's search with '…' smaller.")
            write_something_field = driver.find_elements_by_xpath("//android.view.ViewGroup[@content-desc='Écrivez quelque chose…']")
            logger.info(
                f"{p_udid}|||PhoneBot found the French text field 'Write something...' .:-).")
            write_something_field[0].click()
            return True
        except:
            try:
                logger.info(
                    f"{p_udid}|||PhoneBot didn't find the French text field 'Ecrire quelque chose...'. Let's search for the English one.")
                write_something_field = driver.find_elements_by_xpath(
                    "//android.view.ViewGroup[@content-desc='Write something…']")
                logger.info(
                    f"{p_udid}|||PhoneBot found the English text field 'Write something...'.:-).")
                write_something_field[0].click()
                return True
            except:

                logger.info(
                    f"{p_udid}|||PhoneBot didn't find the English text field 'Write something...'.:-(.")
                # ================= MAYBE THERE IS THE BUTTON JOIN ========================================
                # IN this case we JOIN THE GROUP

                try:
                    logger.info(f"{p_udid}|||PhoneBot will search for 'Join Group' button")
                    join_group_button = driver.find_elements_by_xpath ("//*[@class='android.view.ViewGroup' and starts-with(@content-desc, 'Join ')]")
                    logger.info (f"{p_udid}|||PhoneBot found the English 'Join Group' button")
                    join_group_button[0].click ()
                    return False
                except:
                    try:
                        logger.info (f"{p_udid}|||PhoneBot will search for 'Join Group' button")
                        join_group_button = driver.find_elements_by_xpath (
                            "//*[@class='android.view.ViewGroup' and starts-with(@content-desc, 'Rejoindre ')]")
                        logger.info (f"{p_udid}|||PhoneBot found the French 'Rejoindre le groupe' button")
                        join_group_button[0].click ()
                        return False
                    except:
                        logger.info (f"{p_udid}|||PhoneBot didn't find ENglish and French 'Join Group' button")
                        return False


# ========================================================================================================
# ================================  METHOD TAP ON CENCEL PUBLICATION   ===================================
# ========================================================================================================

def CancelPublishingPost(p_udid, p_driver):
    try:
        button_cancel_publishing_post = p_driver.find_elements_by_xpath(
            "*//android.widget.TextView[@text='Annuler la publication']")
        button_cancel_publishing_post[0].click()
        logger.info(f"{p_udid}|||PhoneBot found the French text 'Annuler la publication'.")
    except:
        logger.info(f"{p_udid}|||PhoneBot didn't find the French text 'Annuler la publication'.")

        try:
            button_cancel_publishing_post = p_driver.find_elements_by_xpath(
                "*//android.widget.TextView[@text='Discard post']")
            button_cancel_publishing_post[0].click()
            logger.info(f"{p_udid}|||PhoneBot found the English text 'Discard post'.")

        except:
            logger.info(f"{p_udid}|||PhoneBot didn't find the English text 'Discard post'.")


# ========================================================================================================
# ================================  METHOD TAP ON GO BACK BUTTON ON FACEBOOK   ===========================
# ========================================================================================================


def GoBackButtonFacebook(p_driver, p_udid):
    # first let's check if we are in Facebook home page, otherwise it will close the app if we click on Android back button
    if not AreWeInFBHomepage(p_udid, p_driver):
        cpt = 0
        while True:

            try:
                back_buttons = p_driver.find_elements_by_xpath(
                    "//*[@class='android.widget.ImageView' and contains(@content-desc, 'Retour')]")
                back_buttons[0].click()
                logger.info(f"{p_udid}|||PhoneBot found the French Back button.")
                break
            except:
                logger.info(f"{p_udid}|||PhoneBot didn't find the French Back button.")

                try:
                    back_buttons = p_driver.find_elements_by_xpath(
                        "//*[@class='android.widget.ImageView' and contains(@content-desc, 'Back')]")
                    back_buttons[0].click()
                    logger.info(f"{p_udid}|||PhoneBot found the English Back button.")

                    break
                except:
                    logger.info(f"{p_udid}|||PhoneBot didn't find the English Back button.")

                    logger.info(
                        f"{p_udid}|||PhoneBot didn't find the English & French 'back' button. Let's try the Android back button.")
                    # === ANDROID BACK BUTTON ============================================
                    p_driver.press_keycode(keycode=4)


                    break

    logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
    time.sleep(random.uniform(0.9, 3.3))


# ==========================================================================================================
# ==============================   METHOD TAP ON SEARCH BUTTON   ===========================================
# ==========================================================================================================

def TaponsearchButton(p_driver, p_udid):
    logger.info(f"{p_udid}|||GoinFacebookGroup - Tap on search button ========================================")
    cpt_TaponsearchButton = 0
    while True:
        try:
            try:
                search_buttons = p_driver.find_elements_by_accessibility_id("Rechercher dans les groupes")
                search_buttons[0].click()
                logger.info(f"{p_udid}|||PhoneBot found the French button 'Rechercher dans les groupes'.")

                break
            except:
                logger.info(f"{p_udid}|||PhoneBot didn't find the French button 'Rechercher dans les groupes'.")

                try:
                    search_buttons = p_driver.find_elements_by_accessibility_id("Search Groups")
                    search_buttons[0].click()
                    logger.info(f"{p_udid}|||PhoneBot found the English button 'Search Groups'.")

                    break
                except:
                    logger.info(f"{p_udid}|||PhoneBot didn't find the English button 'Search Groups'.")
        except Exception as ex:

            logger.error(f"{p_udid}|||{ex} --> PhoneBot couldn't find the 'Search' button. Let's try again.")

    logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")


# ==========================================================================================================
# ==============================     FUNCTION INITIALISATION OF DRIVER     =================================
# ==========================================================================================================
def Initialisation_Driver(p_name_action, p_udid, p_systemPort, p_deviceName, p_version, p_os):
    try:

        # ======================== INITIALISATION OF DRIVER ================================
        logger.info(
            f"{p_udid}|||============== INITIALISATION OF DRIVER for Smartphone {p_udid} for action {p_name_action} ==========")
        logger.info(f"{p_udid}|||p_udid : {p_udid}")
        logger.info(f"{p_udid}|||p_systemPort : {p_systemPort}")
        logger.info(f"{p_udid}|||p_deviceName : {p_deviceName}")
        logger.info(f"{p_udid}|||p_version : {p_version}")
        logger.info(f"{p_udid}|||p_os : {p_os}")
        logger.info(
            f"{p_udid}|||===============================================================================================")

        desired_caps = {}
        desired_caps['automationName'] = 'UiAutomator2'
        desired_caps['platformName'] = p_os
        desired_caps['platformVersion'] = p_version
        desired_caps['deviceName'] = p_deviceName
        desired_caps['udid'] = p_udid
        desired_caps['noReset'] = 'true'
        desired_caps['systemPort'] = p_systemPort
        desired_caps['chromeDriverPort'] = p_systemPort
        desired_caps['appWaitDuration'] = 100000
        desired_caps['newCommandTimeout'] = 0
        desired_caps['wdaStartupRetries'] = 4
        desired_caps['wdaStartupRetryInterval'] = 20000
        desired_caps['uiautomator2ServerLaunchTimeout'] = 100000
        desired_caps['remoteAppsCacheLimit'] = 0
        # desired_caps['appWaitPackage'] = 'com.facebook.android'
        # desired_caps['appWaitActivity'] = '.StartActivity'
        desired_caps['appPackage'] = 'com.facebook.katana'
        desired_caps['appActivity'] = 'com.facebook.katana.LoginActivity'

        while True:
            try:
                driver = webdriver.Remote('http://localhost:4723/wd/hub', desired_caps)
                print(f"desired_caps['appPackage'] : {desired_caps['appPackage']}")
                print(f"desired_caps['appActivity'] : {desired_caps['appActivity']}")
                # driver.update_settings({"normalizeTagNames": True})
                time.sleep(random.uniform(3.5, 5.3))

                return driver

            except ValueError:
                # except:
                logger.critical(f"{p_udid}|||Something went wrong! PLease contact support@phonebot.co")
                logger.critical(
                    f"{p_udid}|||We can't open Facebook. Please check if device is connected. Let's try again!")
    except ValueError:
        logger.critical(f"{p_udid}|||ERROR ")


# ================================================================================================================
# ========================= METHODS FOR CLOSING THE POPUP PUBLISH OLD POST ==================================
# ================================================================================================================


def PublishOldPost(p_driver, p_udid):
    try:
        publish_buttons = p_driver.find_elements_by_xpath(
            "//*[@class='android.widget.Button' and contains(@content-desc, 'PUBLI')]")
        logger.info(
            f"{p_udid}|||We found the 'PUBLIER' French button. We tap on it!")
        GoBackButtonFacebook(p_driver, p_udid)
    except:
        logger.info(
            f"{p_udid}|||We didn't find the 'Publish' button in French. Let's search for English 'POST button'.")

        try:
            publish_buttons = p_driver.find_elements_by_xpath(
                "//android.widget.Button[@content-desc='POST']")
            logger.info(
                f"{p_udid}|||We found the 'POST' english button. We tap on it!")
            GoBackButtonFacebook(p_driver, p_udid)
        except:
            logger.info(
                f"{p_udid}|||We didn't find the 'POST' button in English. :-(.")


# ================================================================================================================
# =========================== FUNCTION TAP ON FILTER GROUP =======================================================
# ================================================================================================================


def TapOnFilterGroup(p_driver, p_udid):
    logger.info(f"{p_udid}|||GoinFacebookGroup - Tap on Filter Groups ========================================")

    while True:
        try:

            try:
                filter_group = p_driver.find_elements_by_xpath("//android.view.ViewGroup[@content-desc='GROUPES']")
                logger.info("PhoneBot found the filter 'GROUPES' in French, let's click on it.")
                filter_group[0].click()
                break

            except:
                logger.info("PhoneBot couldn't find the filter 'GROUPES' in French, let's search for it in English.")

                try:
                    filter_group = p_driver.find_elements_by_xpath("//android.view.ViewGroup[@content-desc='GROUPS']")
                    logger.info("PhoneBot found the filter 'GROUPS' in English, let's click on it.")
                    filter_group[0].click()
                    break

                except:
                    logger.info(
                        "PhoneBot couldn't find the filter 'GROUPES' in English, We may need to move from right to left the horizontal menu filter.")

                    try:
                        horizontal_menu_filters = p_driver.find_elements_by_class("android.view.ViewGroup")
                        for horizontal_menu_filter in horizontal_menu_filters:
                            content_desc_filter = str(horizontal_menu_filter.get_attribute('content-desc')).lower()
                            if content_desc_filter.find('group') != -1:
                                logger.info(f"{p_udid}|||PhoneBot found the filter group in horizontal menu!")
                                horizontal_menu_filter.click()
                                logger.info(
                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                time.sleep(random.uniform(0.9, 3.3))
                                p_driver.implicitly_wait(10)
                                break
                    except:
                        logger.info(
                            f"{p_udid}|||PhoneBot has some issues to Tap on search button. It will try again.")
        except Exception as ex:
            logger.critical(f"{p_udid}|||PhoneBot had a probrem when typing on 'Groups'' filter.")


# ==========================================================================================================
# ==============================     FUNCTION TO GO INSIDE A FACEBOOK GROUP AND CHECK IF USER ==============
# ==============================     IS MEMBER OR NOT OF THE GROUP =========================================
# ==========================================================================================================
def GoinFacebookGroup(driver, p_udid, fb_group, myprofile_username, p_counter,lock):
    logger.info(
        f"============================== START GoinFacebookGroup({p_udid},{fb_group},{myprofile_username},{p_counter}) ========================================")

    # =================================================================================
    # =========================== PLAY STOP OR PAUSE ? ================================
    # =================================================================================
    mymodules.PlayStopPause(p_udid, 'Go in Facebook Group')
    # =================================================================================
    # =================================================================================
    # =================================================================================

    # =================================================================================
    # ================ CHECK IF OLD POST FROM PREVIOUS SESSION IS POPPING UP ? ========
    PublishOldPost(driver, p_udid)
    # ================================================================================================================

    search_field_found = False
    index_menu_group = 2

    logger.info(f"p_counter : {p_counter}")
    if p_counter == 0:
        logger.info(
            f"{p_udid}|||GoinFacebookGroup - Find the Tab menu 'Group' ========================================")
        main_menu_groups_found = False
        while True:
            try:
                # =================================================================================
                # ============= PLAY STOP OR PAUSE ? Search Groups button =========================
                # =================================================================================
                mymodules.PlayStopPause(p_udid, 'Go in Facebook Group')
                # =================================================================================
                # =================================================================================
                # =================================================================================
                index_menu_group += 1
                logger.info(
                    f"PhoneBot is trying to click on groups menu top bar with index_menu_group={index_menu_group}.")
                group_buttons = driver.find_elements_by_class_name("android.view.View")
                print(f"len(group_buttons) : {len(group_buttons)}")
                xpath = "//*[@class='android.view.View'][" + str(index_menu_group) + "]"
                group_button = WebDriverWait(driver, 30).until(
                    EC.element_to_be_clickable(
                        (By.XPATH, xpath)))
                ActionChains(driver).move_to_element(group_button).perform()
                group_button.click()
                logger.info(
                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                time.sleep(random.uniform(3.5, 5.3))
                driver.implicitly_wait(20)

                try:
                    title_menu = driver.find_element(By.XPATH,
                                                      "//android.widget.TextView[@text='Groups']")
                    logger.info(f"{p_udid}|||We open the Groups menu! 'Groups':-)")
                    break
                except:
                    try:
                        logger.info(f"{p_udid}|||We didn't find english title 'Groups', let's try French title!")
                        title_menu = driver.find_element(By.XPATH,
                                                          "//android.widget.TextView[@text='Groupes']")
                        logger.info(f"{p_udid}|||We open the Groups menu! 'Groupes' :-)")
                        break
                    except:

                        logger.info(f"{p_udid}|||We didn't find french title 'Groupes', let's try by the main menu!")
                        # =============================================================================================
                        # As we didn't find the tab Groups, we type in the main menu and then we will search by OCR the menu Groups

                        group_buttons = driver.find_elements_by_xpath(
                            "//android.widget.LinearLayout/android.widget.FrameLayout/android.widget.LinearLayout/android.view.View")
                        len_group_buttons = len(group_buttons)
                        xpath = "//android.widget.LinearLayout/android.widget.FrameLayout/android.widget.LinearLayout/android.view.View[" + str(
                            len_group_buttons - 1) + "]"
                        group_button = WebDriverWait(driver, 30).until(
                            EC.element_to_be_clickable(
                                (By.XPATH, xpath)))
                        ActionChains(driver).move_to_element(group_button).perform()
                        group_button.click()
                        logger.info(
                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                        time.sleep(random.uniform(3.5, 5.3))
                        driver.implicitly_wait(20)

                        # ======= Let's make OCR search. We will have to remove everything except the text and compare with 'Groups'

                        main_menus = driver.find_elements_by_xpath(
                            "//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup")
                        for k in range(0, len(main_menus) - 1):
                            text_main_menu = str(mymodules.GetTextfromScreenshot(driver, p_udid, main_menus[k]))
                            logger.info(f"text_main_menu : {text_main_menu}")
                            lines_text = text_main_menu.split('\n')
                            print(f"lines_text : {lines_text}")
                            logger.info(f"{p_udid}|||PhoneBot will compare now each line of text of the button.")
                            for line_text in lines_text:
                                line_text_clean = line_text.strip()
                                print(f"line_text_clean : {line_text_clean}")

                                if str(line_text_clean).lower() == 'groups' or str(
                                        line_text_clean).lower() == 'groupes':
                                    logger.info(f"{p_udid}|||PhoneBot found the button 'Groups'.")
                                    main_menus[k].click()
                                    #p_counter == 0
                                    main_menu_groups_found = True
                                    break
                                else:
                                    logger.info(f"{p_udid}|||line_text : {line_text} is not the button 'Groups'.")

                        if not main_menu_groups_found:
                            # === Let's try to search for the search field. If we found, we can type the search immediatly there
                            try:
                                search_fields = driver.find_elements_by_class_name("android.widget.EditText")
                                logger.info(f"{p_udid}|||PhoneBot found the field 'Search'.")
                                search_fields[0].click()
                                search_field_found = True
                                break
                            except:
                                logger.error(f"{p_udid}|||PhoneBot didn't find the field 'search'.")
                            GoBackButtonFacebook(driver, p_udid)
                            if index_menu_group == 4:
                                index_menu_group = 1
                        else:
                            break

            except Exception as ex:
                logger.info(
                    f"{p_udid}|||{ex} --> Something went wrong. Let's click on back button and try again to click on Groups menu!")
                # === Let's try to search for the search field. If we found, we can type the search immediatly there
                try:
                    search_fields = driver.find_elements_by_class_name("android.widget.EditText")

                    logger.info(
                        f"{p_udid}|||PhoneBot found the field 'Search'.")
                    search_fields[0].click()
                    search_field_found = True
                    break
                except:
                    logger.info(
                        f"{p_udid}|||PhoneBot couldn't find field 'Search'.")

                    GoBackButtonFacebook(driver, p_udid)

                    if index_menu_group == 4:
                        index_menu_group = 2

    logger.info(f"p_counter : {p_counter}")
    # === Second, we need to tap on search button
    if p_counter == 0 and not search_field_found:
        TaponsearchButton(driver, p_udid)

    # == 2nd ============= Let's click on search field ===================================
    if not search_field_found:
        logger.info(f"{p_udid}|||GoinFacebookGroup - Click on search field ========================================")
        cpt_field_search=0
        while True:
            try:
                search_fields = driver.find_elements_by_class_name('android.widget.EditText')
                logger.info(f"{p_udid}|||PhoneBot found the field 'Search'.")
                search_fields[0].click()
                break

            except:
                cpt_field_search+=1
                if cpt_field_search<3:
                    logger.critical(f"{p_udid}|||PhoneBot couldn't find the 'Search' field. Let's try again.")
                else:
                    GoBackButtonFacebook(driver,p_udid)
                    logger.critical (f"{p_udid}|||PhoneBot click on Go back button")
                    logger.info (f"{p_udid}|||The bot will sleep just a few seconds..............................")
                    time.sleep (random.uniform (0.9, 3.3))
                    driver.implicitly_wait (10)

    # = 3rd ============== We can type the search in the search field ===================
    cpt_search_group = 0
    logger.info(
        f"{p_udid}|||GoinFacebookGroup - Type the search in the search field ========================================")

    while True:
        # found_it = mymodules.SearchFacebook(driver, search_fields[0], fb_group, 0.25, 0.55)
        if cpt_search_group > 0:
            p_bug = True
        else:
            p_bug = False
        search_fields = driver.find_elements_by_class_name('android.widget.EditText')
        p_bug = mymodules.SearchFacebook(driver, search_fields[0], fb_group, p_bug, 0.25, 0.55)
        if p_bug:
            p_bug = mymodules.SearchFacebook(driver, search_fields[0], fb_group, p_bug, 0.25, 0.55)
        search_fields = driver.find_elements_by_class_name('android.widget.EditText')
        fb_group_in_text_field = str(search_fields[0].get_attribute('text')).lower()
        if fb_group_in_text_field == str(fb_group).lower():
            break
        else:
            cpt_search_group += 1
            search_fields[0].click()
            search_fields[0].clear()

    logger.info(f"p_counter : {p_counter}")
    # = 4th ============== We filter the result to display on groups ===================
    # if p_counter != 0:
    logger.info(
        f"{p_udid}|||GoinFacebookGroup - Filter the result to display on groups ========================================")
    logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
    time.sleep(random.uniform(0.9, 3.3))
    driver.implicitly_wait(10)
    TapOnFilterGroup(driver, p_udid)

    # search_fields[0].send_keys(fb_group)
    group_found = False
    member_of_group = False
    element_group_name = None

    logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
    time.sleep(random.uniform(0.9, 3.3))
    driver.implicitly_wait(10)

    # =========================================================================
    # =========================================================================
    # As it is impossible to verify text in android.view.ViewGroup, we need
    # to take the hypothese that 1rst result is the good group
    # We can check if myprofile is member of the group because there are
    # 2 'android.view.ViewGroup' only inside a group box when myprofile is
    # member of the group, whereas there are 3 'android.view.ViewGroup' for
    # non member groups.
    # =========================================================================
    # =========================================================================
    # =========================================================================================
    # ======================= WE NEED TO DISPLAY ALL THE RESULTS ==============================
    # =========================================================================================

    if p_counter == 0:
        logger.info(f"{p_udid}|||GoinFacebookGroup - DISPLAY ALL THE RESULTS ========================================")
        try:
            view_all_buttons = driver.find_elements_by_xpath("//android.view.ViewGroup[@content-desc='BUTTON']")
            for view_all_button in view_all_buttons:

                text_view_all_button = mymodules.GetTextfromScreenshot(driver, p_udid, view_all_button)
                logger.info(f"text_view_all_button : {text_view_all_button}")
                if str(text_view_all_button).lower() == 'voir tout' or str(text_view_all_button).lower() == 'view all':
                    logger.info(f"{p_udid}|||PhoneBot found the button 'VIEW ALL'.")
                    view_all_button.click()
                    break
        except:
            try:
                logger.info(
                    f"{p_udid}|||PhoneBot didn't find the English button 'VIEW ALL'. Let's search for the French one.")
                view_all_buttons = driver.find_elements_by_xpath("//android.view.ViewGroup[@content-desc='BOUTON']")

                for view_all_button in view_all_buttons:
                    text_view_all_button = mymodules.GetTextfromScreenshot(driver, p_udid, view_all_button)
                    logger.info(f"text_view_all_button : {text_view_all_button}")
                    if str(text_view_all_button).lower() == 'voir tout' or str(
                            text_view_all_button).lower() == 'view all':
                        logger.info(f"{p_udid}|||PhoneBot found the button 'VIEW ALL'.")
                        view_all_button.click()
                        break
            except:
                logger.info(
                    f"{p_udid}|||PhoneBot didn't find the French button 'VIEW ALL'. We will click on 'GROUPS' tab filer.")

        logger.info(
            f"{p_udid}|||The bot will sleep just a few seconds..............................")
        time.sleep(random.uniform(0.9, 3.3))
        driver.implicitly_wait(10)

    # =========================================================================================
    # ========== WE NEED TO CLICK AND GO IN EACH GROUP TO CHECK THE NAME OF GROUPS ============
    # ===================== AND IF THE USER IS MEMBER OF THE GROUP ============================
    # =========================================================================================
    logger.info(
        f"{p_udid}|||GoinFacebookGroup - CLICK AND GO IN EACH GROUP TO CHECK THE NAME OF GROUPS ========================================")
    result_groups = driver.find_elements_by_xpath("(//*[@class='androidx.recyclerview.widget.RecyclerView'])[2]/*[@class='android.view.ViewGroup']")
    number_result_groups_found = len(result_groups)
    logger.info(f"{p_udid}|||number_result_groups_found : {number_result_groups_found}")
    if number_result_groups_found == 0:
        logger.info(
            f"{p_udid}|||PhoneBot didn't find your group '{fb_group}'!")
    else:
        logger.info(
            f"{p_udid}|||PhoneBot found some groups '{fb_group}! It will check if you are member and if the name of group correspond to '{fb_group}'.")
        index_group = 0
        cpt_scroll = 0
        list_fb_group_name = []
        cpt_content_desc_in_list_fb_group_name = 0
        cpt_loop = 0
        number_group_checked=0
        while index_group <= number_result_groups_found:
            logger.info(f"{p_udid}|||# -------------------- (1) WE GO INSIDE THE GROUP ---------------------------")
            cpt_loop += 1
            logger.info(f"{p_udid}|||index_group : {index_group}/{number_result_groups_found - 1}")
            logger.info(f"{p_udid}|||PhoneBot go in the loop for each group found.")
            result_groups[index_group].click()
            logger.info(
                f"{p_udid}|||The bot will sleep just a few seconds..............................")
            time.sleep(random.uniform(3.5, 5.3))
            # driver.implicitly_wait(15)
            # === We need to scroll up in order to hide any tiny popup meesages ===============
            mymodules.Scroll_Up(driver, p_udid)
            logger.info(
                f"{p_udid}|||The bot will sleep just a few seconds..............................")
            time.sleep(random.uniform(1.9, 3.3))
            # driver.implicitly_wait(5)
            logger.info(f"{p_udid}|||# -------------------- (2) SEARCH FOR THE TITLE OF GROUP ------------------------")
            we_are_in_group,title_group,element_group_name = CheckIfWeAreInGroup(driver,p_udid)  # because it is still not sure we are in a group -------------------------
            print(f"Are we in group? : {we_are_in_group}")
            # ----------------------------------------------------------------------------------------------------
            if we_are_in_group:
                number_group_checked+=1
                group_found = False
                member_of_group = True

                if title_group.find(fb_group) != -1:
                    logger.info(f"{p_udid}|||!!!BINGO!!!PhoneBot is actually in the group '{fb_group}'.")
                    group_found = True
                    logger.info(f"{p_udid}||| Let's check now if you are member of the group '{fb_group}'.")
                    elements_of_group = driver.find_elements_by_class_name("android.view.ViewGroup")
                    member_of_group = True

                    # -------------- (3) CHECK THE NAME OF THE GROUP AND IF USER IS MEMBER OF THE GROUP -------------------
                    for element_of_group in elements_of_group:
                        logger.info(
                            f"{p_udid}|||PhoneBot go in the loop for each element of the group in order to find the name of group and the button 'Join group'.")
                        content_desc = ''
                        try:
                            content_desc = str(element_of_group.get_attribute('content-desc'))
                        except:
                            logger.info(f"{p_udid}|||There was no 'content-desc' for this element.")

                        if content_desc != '':
                            conten_desc = str (content_desc).lower()
                            logger.info(
                                f"{p_udid}||| PhoneBot will check if '{myprofile_username} is member of group '{fb_group}.")
                            logger.info(f"{p_udid}||| content_desc : {content_desc}")
                            if str(content_desc).startswith('rejoindre ') != -1:
                                logger.info(f"{p_udid}|||content_desc : {content_desc}")
                                logger.info(f"{p_udid}|||'{myprofile_username}' is not member of this group.")
                                status_group=mymodules.AddActionStatus('not member',p_udid,'facebook',myprofile_username,fb_group,'You need to be member of this group...',lock)
                                member_of_group = False
                            if str(content_desc).startswith('join ') != -1:
                                logger.info(f"{p_udid}|||content_desc : {content_desc}")
                                logger.info(f"{p_udid}|||'{myprofile_username}' is not member of this group.")
                                status_group = mymodules.AddActionStatus ('not member', p_udid, 'facebook',
                                                                             myprofile_username, fb_group,
                                                                             'You need to be member of this group...',
                                                                             lock)

                                member_of_group = False
                            if str(content_desc).startswith('cancel ') != -1:
                                logger.info(f"{p_udid}|||content_desc : {content_desc}")
                                logger.info(f"{p_udid}|||'{myprofile_username}' is not member of this group.")
                                status_group = mymodules.AddActionStatus ('pending registration', p_udid, 'facebook',
                                                                          myprofile_username, fb_group,
                                                                          'You need to wait to be accepted in this group...',
                                                                          lock)

                                member_of_group = False
                            if str(content_desc).find('annuler ') != -1:
                                logger.info(f"{p_udid}|||content_desc : {content_desc}")
                                logger.info(f"{p_udid}|||'{myprofile_username}' is not member of this group.")
                                status_group = mymodules.AddActionStatus ('pending registration', p_udid, 'facebook',
                                                                          myprofile_username, fb_group,
                                                                          'You need to wait to be accepted in this group...',
                                                                          lock)
                                member_of_group = False
                if group_found:
                    logger.info(
                        f"{p_udid}|||PhoneBot found the group '{fb_group}'. PhoneBot can stop to check all the results of the search of groups.")
                    return group_found, member_of_group, element_group_name, p_bug
                try:
                    GoBackButtonFacebook(driver, p_udid)
                except:
                    logger.info(f"{p_udid}|||We couldn't go back :-(")
            # ===============================================================================================
            # We advanced to the right this block below
            logger.info(f"{p_udid}|||# -------------- (4) WE EXIT THE GROUP  ------------------------")
            # result_groups = driver.find_elements_by_xpath("(//*[@class='androidx.recyclerview.widget.RecyclerView'])[2]/*[@class='android.view.ViewGroup']")
            # number_result_groups_found = len(result_groups)
            #if cpt_scroll > 0:
                #mymodules.Scroll_Down(driver, p_udid, cpt_scroll + 1)
            logger.info(f"{p_udid}|||# === We need to check if we were at the last group displayed in results ====")
            logger.info(f"{p_udid}|||index_group : {index_group}/{number_result_groups_found - 1}")
            result_groups = driver.find_elements_by_xpath(
                "(//*[@class='androidx.recyclerview.widget.RecyclerView'])[2]/*[@class='android.view.ViewGroup']")
            number_result_groups_found = len(result_groups)
            print(f"index_group : {index_group} / {number_result_groups_found - 1} : number_result_groups_found")
            if index_group == (number_result_groups_found - 1):
                logger.info(f"{p_udid}|||index_group == number_result_groups_found-1 => We scroll")
                mymodules.Scroll_Down(driver, p_udid)
                cpt_scroll += 1

                logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                time.sleep(random.uniform(1.9, 3.3))
                driver.implicitly_wait(10)
                new_result_groups = driver.find_elements_by_xpath(
                    "(//*[@class='androidx.recyclerview.widget.RecyclerView'])[2]/*[@class='android.view.ViewGroup']")
                new_number_result_groups_found = len(new_result_groups)

                if new_result_groups[new_number_result_groups_found - 1] == result_groups[
                    number_result_groups_found - 1]:
                    logger.info(
                        f"{p_udid}||| new_result_groups = result_groups => It is the end of checking the groups!")
                    return group_found, member_of_group, element_group_name, p_bug
                else:
                    logger.info(
                        f"{p_udid}||| new_result_groups <> result_groups => It is NOT the end the groups results. We reset index_group to 0!")
                    index_group = 0
                    result_groups = driver.find_elements_by_xpath(
                        "(//*[@class='androidx.recyclerview.widget.RecyclerView'])[2]/*[@class='android.view.ViewGroup']")
                    number_result_groups_found = len(result_groups)
            elif number_group_checked == 10:
                logger.info(
                    f"{p_udid}||| Sorry! PhoneBot didn't find the facebook group {fb_group}'! Let's search another group.")
                group_found = False
                member_of_group = False
                element_group_name = ''
                p_bug = False
                break

            else:
                logger.info(
                    f"{p_udid}||| new_result_groups <> result_groups => There are more groups to check!")
                result_groups = driver.find_elements_by_xpath(
                    "(//*[@class='androidx.recyclerview.widget.RecyclerView'])[2]/*[@class='android.view.ViewGroup']")
                number_result_groups_found = len(result_groups)
                index_group += 1

            if cpt_loop > 10:
                group_found = False
                return group_found, member_of_group, element_group_name, p_bug

    return group_found, member_of_group, element_group_name, p_bug


# =====================================================================================================================
# ====================================== FUNCTION TO KNOW IF WE ARE IN HOMEPAGE =======================================
# =====================================================================================================================
def AreWeInFBHomepage(p_udid, p_driver):
    #pdb.set_trace()
    # first let's check if we are in Facebook home page, otherwise it will close the app if we click on Android back button
    we_are_in_homepage = False
    try:
        logo_facebook = p_driver.find_elements_by_xpath(
            "*//android.widget.FrameLayout/android.widget.LinearLayout/android.widget.FrameLayout/android.widget.LinearLayout/android.widget.FrameLayout/android.widget.LinearLayout/android.widget.ImageView")
        logo_facebook_string = str(mymodules.GetTextfromScreenshot(p_driver, p_udid, logo_facebook[0])).lower()
        logo_facebook_string=logo_facebook_string.strip()
        logo_facebook_string = logo_facebook_string.replace('\n','').replace('\\n','')

        logger.info(f"{p_udid}||| logo_facebook_string : {logo_facebook_string}")
        if logo_facebook_string == 'facebook':
            logger.info(
                f"{p_udid}||| PhoneBot found the logo 'Facebook'. That means we are in homepage. PhoneBot will not go back!")
            we_are_in_homepage = True
        else:
            logger.info(
                f"{p_udid}||| PhoneBot didn't find the logo 'Facebook'. That means we are not in homepage. PhoneBot will go back!")
            we_are_in_homepage = False
    except:
        we_are_in_homepage = False

    return we_are_in_homepage


def StartBot(p_name_action='', p_udid='', p_systemPort='', p_deviceName='', p_version='', p_os='',
             p_quantity_share_groups=1,
             p_quantity_max_message=1, p_quantity_max_scrap=1, p_quantity_max_add_friend=1, lock=''):
    """

    :param p_name_action:
    :param p_udid:
    :param p_systemPort:
    :param p_deviceName:
    :param p_version:
    :param p_os:
    :param p_quantity_share_groups:
    :param p_quantity_max_message:
    :param p_quantity_max_scrap:
    :param p_quantity_max_add_friend:
    :param lock:
    :return:
    """
    try:

        # =================================================================================
        # =========================== PLAY STOP OR PAUSE ? ================================
        # =================================================================================
        mymodules.PlayStopPause(p_udid, 'Facebook')
        # =================================================================================
        # =================================================================================
        # =================================================================================

        logger.info(
            f"{p_udid}|||================= STARTING TASK {p_name_action} for Smartphone {p_udid} =========================")
        logger.info(
            f"{p_udid}|||# ======================== [1] INITIALISATION OF DRIVER ================================")
        driver = Initialisation_Driver(p_name_action, p_udid, p_systemPort, p_deviceName, p_version, p_os)
        logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
        time.sleep(random.uniform(3.5, 5.3))
        driver.implicitly_wait(10)

        logger.info(
            f"{p_udid}|||# ======================== [2] INITIALISATION OF DATABASE db.db ============================")
        sqliteConnection = sqlite3.connect(mymodules.LoadFile('db.db'))  # we prepare db
        cursor1 = sqliteConnection.cursor()
        logger.info(f"{p_udid}|||INITIALISATION OF DATABASE db.db")

        # ========================================================================================================
        # ================= We need to be sure we are in home page ===============================================
        # ========================================================================================================
        cpt=0
        while not AreWeInFBHomepage(p_udid, driver):
            cpt+=1
            if cpt>5:
                break
            else:
                GoBackButtonFacebook(driver, p_udid)
        # ========================================================================================================
        logger.info(
            f"{p_udid}|||# ==================== [3] GET FACEBOOK ACCOUNT USERNAME OF THE PHONE =========================")
        #                     We need to know WHO will do the automation tasks

        # ==========================================================================================

        while True:
            # =================================================================================
            # =========================== PLAY STOP OR PAUSE ? ================================
            # =================================================================================
            mymodules.PlayStopPause(p_udid, 'Facebook Find your profile Username')
            # =================================================================================
            # =================================================================================
            # =================================================================================

            try:

                # ===================================================================================================
                # =============================== CLICK ON TOP RIGHT MENU BUTTON ====================================
                # ===================================================================================================
                while True:
                    # =================================================================================
                    # =========================== PLAY STOP OR PAUSE ? ================================
                    # =================================================================================
                    mymodules.PlayStopPause(p_udid, 'Facebook CLick on Top-Right Menu')
                    # =================================================================================
                    # =================================================================================
                    # =================================================================================
                    try:
                        # === We click on top right corner menu ========================================================
                        menu_buttons = driver.find_elements_by_xpath(
                            "//*[@class='android.view.View' and contains(@content-desc, 'Menu')]")

                        ActionChains(driver).move_to_element(menu_buttons[0]).perform()
                        menu_buttons[0].click()
                        logger.info(f"{p_udid}|||PhoneBot click on top right 'Menu' button")
                        logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                        time.sleep(random.uniform(0.9, 3.3))
                        driver.implicitly_wait(10)
                        try:
                            title_menu = driver.find_elements(By.XPATH, "//android.widget.TextView[@text='Menu']")
                            logger.info(f"{p_udid}|||We open the menu! :-)")
                            break
                        except:
                            logger.info(f"{p_udid}|||We didn't open the menu, let's try again!")


                    except:
                        logger.info(
                            f"{p_udid}|||Something wen wrong. Let's click on back button and try again to click on top right menu!")
                        try:
                            GoBackButtonFacebook(driver, p_udid)
                        except:
                            logger.info(f"{p_udid}|||We couldn't go back :-(")

                # ====== We identified the 'MENU' Label ----------------------------------------------------------------

                while True:
                    # =================================================================================
                    # =========================== PLAY STOP OR PAUSE ? ================================
                    # =================================================================================
                    mymodules.PlayStopPause(p_udid, 'Facebook See Profile page')
                    # =================================================================================
                    # =================================================================================
                    # =================================================================================

                    # === We click on the profile thumbnail to open profile page and get the username ================
                    see_profile_tmp = WebDriverWait(driver, 30).until(EC.presence_of_all_elements_located((By.XPATH,
                                                                                                           '//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup[1]/android.view.ViewGroup')))
                    try:
                        see_profile = driver.find_elements_by_xpath(
                            "//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup[1]/android.view.ViewGroup")

                        logger.info(f"{p_udid}|||PhoneBot found your 'See profile' menu.")
                        see_profile[0].click()
                        logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                        time.sleep(random.uniform(1.9, 3.3))
                        driver.implicitly_wait(10)
                        # === Let's scroll up a bit in case there is a popup
                        mymodules.Scroll_Up(driver, p_udid)
                        logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                        time.sleep(random.uniform(0.9, 3.3))
                        driver.implicitly_wait(10)

                        # === We extract the username ==============================================================
                        my_username_element_tmp = WebDriverWait(driver, 30).until(EC.presence_of_all_elements_located((By.XPATH,
                                                                                                               '//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup[2]/android.view.ViewGroup')))
                        try:
                            my_username_element = driver.find_elements_by_xpath("//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup[2]/android.view.ViewGroup")

                            logger.info(f"{p_udid}|||PhoneBot found your profile username.")
                            myprofile_username = mymodules.GetTextfromScreenshot(driver, p_udid, my_username_element[0])
                            myprofile_username = str(myprofile_username).strip()
                            print(f"myprofile_username : {myprofile_username}")
                            is_good_username=mymodules.CompareFBUsername(p_udid,'facebook',myprofile_username,'facebook_username')
                            if is_good_username:
                                break
                        except:
                            logger.error(f"{p_udid}|||PhoneBot didn't find username.")
                    except:

                        logger.info(f"{p_udid}|||PhoneBot didn't find the username. Let's try again!.")

                    GoBackButtonFacebook(driver,p_udid)
                    logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                    time.sleep(random.uniform(0.9, 2.3))
                    driver.implicitly_wait(10)
                    GoBackButtonFacebook(driver, p_udid)






                logger.info(f"{p_udid}|||Your Facebook username is '{myprofile_username}'")
                logger.info(f"{p_udid}|||Let's compare '{myprofile_username}' to the one you add in your Account details on https://phonebot.co")

                logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                time.sleep(random.uniform(0.9, 2.3))
                driver.implicitly_wait(5)

                # ========================== Let's go back to home page with BACK button ==========================
                GoBackButtonFacebook(driver,p_udid)
                logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                time.sleep(random.uniform(0.9, 2.3))
                driver.implicitly_wait(10)
                GoBackButtonFacebook(driver,p_udid)
                logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                time.sleep(random.uniform(0.9, 2.3))
                driver.implicitly_wait(10)


                break  # Only triggered if input is valid...
            except ValueError:
                logger.critical(f"{p_udid}|||We could'nt get the username on Facebook!")
                logger.critical(f"{p_udid}|||Let's try again!")

        # =================================================================================
        # =========================== PLAY STOP OR PAUSE ? ================================
        # =================================================================================
        mymodules.PlayStopPause(p_udid, 'Facebook Get the parameters')
        # =================================================================================
        # =================================================================================
        # =================================================================================

        logger.info(
            f"{p_udid}|||# ======= [4] WE GET THE PARAMETERS OF Facebook BOT for '{myprofile_username}' FROM 'Account details' ON Phonebot.co =============")

        facebook_username = mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username,
                                                              'facebook_username')
        facebook_send_message = int(
            mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username, 'facebook_send_message'))
        facebook_message = mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username, 'facebook_message')
        facebook_list_groups_scrap_message = mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username,
                                                                               'facebook_list_groups_scrap_message')
        facebook_list_groups_share_url = mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username,
                                                                           'facebook_list_groups_share_url')
        facebook_list_pages_scrap_message = mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username,
                                                                              'facebook_list_pages_scrap_message')
        facebook_list_posts_to_share = mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username,
                                                                         'facebook_list_posts_to_share')
        facebook_scrap_members_groups_pages = int(
            mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username,
                                              'facebook_scrap_members_groups_pages'))
        facebook_share_posts_in_groups = int(
            mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username, 'facebook_share_posts_in_groups'))
        facebook_add_friend_from_group = int(
            mymodules.GetValueFromCustomField(p_udid, 'facebook', myprofile_username, 'facebook_add_friend_from_group'))

        logger.info(f"{p_udid}|||facebook_username : {facebook_username} {type(facebook_username)}")
        logger.info(f"{p_udid}|||facebook_send_message : {facebook_send_message} {type(facebook_send_message)}")
        logger.info(f"{p_udid}|||facebook_message : {facebook_message} {type(facebook_message)}")
        logger.info(f"{p_udid}|||facebook_list_groups_scrap_message : {facebook_list_groups_scrap_message} {type(facebook_list_groups_scrap_message)}")
        logger.info(f"{p_udid}|||facebook_list_groups_share_url : {facebook_list_groups_share_url} {type(facebook_list_groups_share_url)}")
        logger.info(f"{p_udid}|||facebook_list_pages_scrap_message : {facebook_list_pages_scrap_message} {type(facebook_list_pages_scrap_message)}")
        logger.info(f"{p_udid}|||facebook_list_posts_to_share : {facebook_list_posts_to_share} {type(facebook_list_posts_to_share)}")
        logger.info(f"{p_udid}|||facebook_scrap_members_groups_pages : {facebook_scrap_members_groups_pages} {type(facebook_scrap_members_groups_pages)}")
        logger.info(f"{p_udid}|||facebook_share_posts_in_groups : {facebook_share_posts_in_groups} {type(facebook_share_posts_in_groups)}")
        logger.info(f"{p_udid}|||facebook_add_friend_from_group : {facebook_add_friend_from_group} {type(facebook_add_friend_from_group)}")


        logger.info("# ==========================================================================================")

        driver.implicitly_wait(30)
        logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
        time.sleep(random.uniform(1.9, 3.3))

        logger.info(
            f"{p_udid}|||# ================= [6] WE INITIALISE THE COUNTERS WHICH CAN'T GO OVER THE DAILY LIMIT PARAMETERS =========")


        counter_Facebook_Share_posts_in_groups = 0
        counter_round =0

        logger.info(f"{p_udid}|||# ================= [7] WE INTIALISE THE FLAGS ================================")

        # =========================================================================================================
        # This time we will not loop in table contacts because it is difficult to search for a user in Facebook
        # There are too many users. So we will make the tasks from the lists.

        # =========================================================================================================
        # ======================== LET'S START TO SHARE SOME POSTS ON FACEBOOK GROUPS =============================
        # =========================================================================================================

        if p_quantity_share_groups !=0:
            if facebook_share_posts_in_groups == 1:
                logger.info(
                    f"{p_udid}|||VERIFICATION 1 CORRECT => The options 'Share posts in Facebook groups' from 'Account details' is activated.")
                if facebook_list_groups_share_url != '':
                    logger.info(
                        f"{p_udid}|||VERIFICATION 2 CORRECT => The textarea 'List of groups' from 'Account details' is not empty.")
                    if facebook_share_posts_in_groups != '':
                        logger.info(
                            f"{p_udid}|||VERIFICATION 3 CORRECT => The textarea 'List of posts' from 'Account details' is not empty.")

                        # =================================================================================
                        # =========================== PLAY STOP OR PAUSE ? ================================
                        # =================================================================================
                        mymodules.PlayStopPause(p_udid, 'Facebook Share Post in Groups')
                        # =================================================================================
                        # =================================================================================
                        # =================================================================================

                        # ======================= [1] We need to prepare the list of Facebook groups ======================
                        logger.info(
                            f"{p_udid}|||# =========== [1] We need to prepare the list of Facebook groups ===========")
                        facebook_list_groups_share_url = facebook_list_groups_share_url.split('\\n')
                        logger.info(f"{p_udid}|||facebook_list_groups_share_url : {facebook_list_groups_share_url}")
                        # =================================================================================================
                        # ============= [2] We need to prepare the list of posts to be shared in Facebook groups ==========
                        logger.info(
                            f"{p_udid}|||# ============= [2] We need to prepare the list of posts to be shared in Facebook groups =====================")
                        facebook_list_posts_to_share = facebook_list_posts_to_share.split(';;;')
                        logger.info(f"{p_udid}|||facebook_list_posts_to_share : {facebook_list_posts_to_share}")
                        # =================================================================================================
                        # ============= [3] We can start the loop until we reach the maximum limit ========================
                        logger.info(
                            f"{p_udid}|||# ============= [3] We can start the loop until we reach the maximum limit =====================")
                        while counter_Facebook_Share_posts_in_groups <= p_quantity_share_groups:

                            # =================================================================================
                            # =========================== PLAY STOP OR PAUSE ? ================================
                            # =================================================================================
                            mymodules.PlayStopPause(p_udid, 'Facebook Share Post in Groups')
                            # =================================================================================
                            # =================================================================================
                            # =================================================================================


                            # ============= [3.1] We can start the loop to go for each post ===============================
                            logger.info(
                                f"{p_udid}|||# ============= [3.1] We can start the loop to go for each post ====================")
                            list_fb_group_NOT_FOUND = []
                            for post in facebook_list_posts_to_share:
                                # =================================================================================
                                # =========================== PLAY STOP OR PAUSE ? ================================
                                # =================================================================================
                                mymodules.PlayStopPause(p_udid, 'Facebook Share Post in Groups')
                                # =================================================================================
                                # =================================================================================
                                # =================================================================================
                                # ====================== Let's prepare the post ===========================================
                                post = post.replace('\r\n', '|').replace('\\n', '|')
                                post = unidecode.unidecode(post)
                                logger.info(f"{p_udid}|||post : {post}")
                                logger.info(f"post : {post}")

                                # ============= [3.1.1] We can start the loop to go for each group ========================
                                logger.info(
                                    f"{p_udid}|||# ============= [3.1.1] We can start the loop to go for each group =====================")

                                for fb_group in facebook_list_groups_share_url:
                                    logger.info(f"{p_udid}|||********************** START CHECKING FB GROUP {fb_group} *************************************")
                                    logger.info(f"{p_udid}|||list_fb_group_NOT_FOUND : {list_fb_group_NOT_FOUND}")
                                    if fb_group in list_fb_group_NOT_FOUND:
                                        logger.error(
                                            f"{p_udid}|||This group {fb_group} was already searched and not found. You should remove it from your list.\nPhoneBot will now stop the task 'Publish post in FB groups' and start the next task.")
                                        counter_Facebook_Share_posts_in_groups = p_quantity_share_groups
                                        break
                                    counter_round += 1
                                    print(f"counter_round :{counter_round}")
                                    # =================================================================================
                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                    # =================================================================================
                                    mymodules.PlayStopPause(p_udid, 'Facebook Share Post in Groups')
                                    # =================================================================================
                                    # =================================================================================
                                    # =================================================================================
                                    # =================== We prepare the string for searching facebook group =============
                                    fb_group_unicode = html.unescape(unidecode.unidecode(fb_group))
                                    logger.info(f"{p_udid}|||fb_group_unicode : {fb_group_unicode}")

                                    # =================== Before to start the process of searching group and publish post
                                    # =================== We need to check if this post was not already published in the
                                    # =================== group
                                    if cursor1.execute(
                                            "SELECT * FROM actions WHERE platform=? AND id_social_account=? AND message=? AND type_action=? AND fb_group_name=?",
                                            ('facebook', myprofile_username, post, 'share_post_fb', fb_group)).fetchone():
                                        logger.info(
                                            f"{p_udid}|||This post was already published in the group '{fb_group}' by '{myprofile_username}'!")
                                    else:
                                        logger.info(
                                            f"{p_udid}|||This post was NEVER published in the group '{fb_group}' by '{myprofile_username}'!")
                                        logger.info(f"{p_udid}|||We will publish it!")

                                        # =================== Let's search for the group =====================================
                                        # === First, we need to tap on group button

                                        group_found, member_of_group, element_group_name ,p_bug= GoinFacebookGroup(driver, p_udid,
                                                                                                             fb_group,
                                                                                                             myprofile_username,
                                                                                                             counter_Facebook_Share_posts_in_groups,lock)


                                        # =========================================================================================
                                        # ========== WE NEED TO CHECK IF THE USER IS MEMBER OF THE GROUP ==========================
                                        # =========================================================================================
                                        if group_found:
                                            logger.info(
                                                f"{p_udid}|||VERIFICATION 1 CORRECT : group '{fb_group}' was found!")
                                            if member_of_group:
                                                logger.info(
                                                    f"{p_udid}|||VERIFICATION 2 CORRECT : '{myprofile_username}' is member of '{fb_group}'")
                                                logger.info(f"{p_udid}|||PhoneBot is inside the group.")
                                                # ====================================================================================
                                                # ================ WE ARE IN THE GROUP, LET'S PUBLISH THE POST =======================
                                                # === 1rst ======== We need to tap on "Write something" field ========================
                                                write_post_ready = PrepareWritingFacebookPost(driver,
                                                                                              p_udid)  # function to open the 'Publish a post form'
                                                if not write_post_ready:
                                                    logger.info(
                                                        f"{p_udid}|||Maybe we are in some kind of Market place group. Let's search for the 'Discussion' button.")
                                                    try:
                                                        discussion_button = driver.find_elements_by_xpath(
                                                            "//android.view.ViewGroup[@content-desc='Discussion']")
                                                        logger.info(
                                                            f"{p_udid}|||PhoneBot found the 'Discussion' button.")
                                                        discussion_button[0].click()
                                                        logger.info(
                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                        time.sleep(random.uniform(0.9, 2.3))
                                                        driver.implicitly_wait(5)
                                                        write_post_ready = PrepareWritingFacebookPost(driver, p_udid)
                                                        if write_post_ready:
                                                            write_post_form = True
                                                        else:
                                                            write_post_form = False
                                                    except:
                                                        logger.info(
                                                            f"{p_udid}|||PhoneBot didn't find the 'Discussion' button. We need to skip this group!")
                                                        write_post_form = False
                                                        GoBackButtonFacebook(driver,p_udid)


                                                else:
                                                    write_post_form = True

                                                logger.info(
                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                time.sleep(random.uniform(2.9, 5.3))
                                                driver.implicitly_wait(10)

                                                # === The variable write_post_form = True is letting PhoneBot know if we are in the form
                                                # === to publish a discussion post in Facebook group or NOT!!
                                                if write_post_form:
                                                    # =================================================================================
                                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                                    # =================================================================================
                                                    mymodules.PlayStopPause(p_udid, 'Facebook Share Post in Groups')
                                                    # =================================================================================
                                                    # =================================================================================
                                                    # =================================================================================
                                                    # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                                                    # !!!!!!!!!!!!!!!!!!! HERE CAN COME A POPUP ASKING IF myprofile WANT TO MAKE     !!
                                                    # !!!!!!!!!!!!!!!!!!! HIS POST PUBLIC OR ONLY FOR FRIENDS !!!!!!!!!!!!!!!!!!!!!!!!!
                                                    try:
                                                        popup_buttons = driver.find_elements_by_xpath(
                                                            "//*[@class='android.view.View' and contains(@content-desc, 'Public')]")
                                                        logger.info(
                                                            f"{p_udid}|||We found the 'Public' button of POPUP. We tap on it!")
                                                        popup_buttons[0].click()
                                                    except:
                                                        logger.info(
                                                            f"{p_udid}|||We didn't find the 'Public' button of POPUP!")


                                                    # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                                                    post_textarea_field = driver.find_element_by_class_name(
                                                        "android.widget.EditText")
                                                    post_textarea_field.click()
                                                    # ==== 2nd ========= We can type the post in the textarea ===========================


                                                    p_bug=mymodules.WriteFacebookPost(driver, post_textarea_field, post,p_bug, 0.5,0.75)


                                                    logger.info(
                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                    time.sleep(random.uniform(7.9, 12.3))
                                                    driver.implicitly_wait(10)
                                                    # ==== 3rd ========= We tap on 'Publish' button ====================================
                                                    try:
                                                        publish_buttons = driver.find_elements_by_xpath(
                                                            "//*[@class='android.widget.Button' and contains(@content-desc, 'PUBLI')]")
                                                        logger.info(
                                                            f"{p_udid}|||We found the 'PUBLIER' French button. We tap on it!")
                                                        publish_buttons[0].click()
                                                        logger.info(
                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                        time.sleep(random.uniform(2.9, 5.3))
                                                        driver.implicitly_wait(10)
                                                    except:
                                                        try:
                                                            logger.info(
                                                                f"{p_udid}|||We didn't find the 'Publish' button in French. Let's search for English 'POST button'.")
                                                            publish_buttons = driver.find_elements_by_xpath(
                                                                "//android.widget.Button[@content-desc='POST']")
                                                            logger.info(
                                                                f"{p_udid}|||We found the 'POST' english button. We tap on it!")
                                                            publish_buttons[0].click()
                                                        except:
                                                            logger.info(
                                                                f"{p_udid}|||We didn't find the 'POST' button in English. :-(.")
                                                            break



                                                    # === Maybe there will be a popup telling "Your post need to be reviewed by Administrator...."
                                                    try:
                                                        popup_reviewed_by_admin = driver.find_elements_by_xpath(
                                                            "//android.widget.Button[@text='OK']")

                                                        popup_reviewed_by_admin[0].click()
                                                        logger.info(
                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                        time.sleep(random.uniform(0.9, 2.3))
                                                        driver.implicitly_wait(10)
                                                    except:
                                                        logger.info(
                                                            f"{p_udid}|||PhoneBot didn't find popup 'Review post by admin'")

                                                    # ===== 4th ==== We need now to tap on 'BACK' button one time to come back to the
                                                    # ============== search of groups
                                                    GoBackButtonFacebook(driver, p_udid)
                                                    # ===== 5th ==== We need to Insert a row in local database table 'actions' ========
                                                    now = datetime.now()
                                                    date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                    with lock:
                                                        cursor1.execute(
                                                            "INSERT INTO actions (platform,id_smartphone,id_social_account, message,type_action,date,fb_group_name) VALUES(?,?,?,?,?,?,?)",
                                                            ('facebook', p_udid, myprofile_username, post, 'share_post_fb',
                                                             date_n_time, fb_group))
                                                        sqliteConnection.commit()
                                                        counter_Facebook_Share_posts_in_groups += 1
                                                        counter_round += 1
                                                        logger.info (f"{p_udid}|||counter_round : {counter_round}/{p_quantity_share_groups} : p_quantity_share_groups")

                                                    logger.info(
                                                        f"{p_udid}|||counter_Facebook_Share_posts_in_groups : {counter_Facebook_Share_posts_in_groups}/{p_quantity_share_groups} : p_quantity_share_groups")
                                                    # ===== 6th ==== We need to check if we reach the limit ==========================
                                                    if counter_Facebook_Share_posts_in_groups >= p_quantity_share_groups:
                                                        logger.info(
                                                            f"{p_udid}|||We reach the limited quantity of sharing post!")

                                                        break

                                                    counter_round += 1
                                                    logger.info (f"{p_udid}|||counter_round : {counter_round}/{p_quantity_share_groups} : p_quantity_share_groups")
                                                    if counter_round >= p_quantity_share_groups:
                                                        break
                                                else:
                                                    counter_round += 1
                                                    logger.info (
                                                        f"{p_udid}|||counter_round : {counter_round}/{p_quantity_share_groups} : p_quantity_share_groups")
                                                    if counter_round >= p_quantity_share_groups:
                                                        break

                                            else:
                                                logger.info(f"{p_udid}|||VERIFICATION 2 FAILED: '{myprofile_username}' is NOT member of '{fb_group}'")
                                                GoBackButtonFacebook(driver,p_udid)

                                        else:
                                            logger.info(
                                                 f"{p_udid}|||VERIFICATION 1 FAILED : group '{fb_group}' was NOT found!")
                                            list_fb_group_NOT_FOUND.append(fb_group)
                                            logger.info(
                                                f"{p_udid}|||The group {fb_group} was added to the list list_fb_group_NOT_FOUND")
                                            logger.info(
                                                f"{p_udid}|||list_fb_group_NOT_FOUND : {list_fb_group_NOT_FOUND}")
                                    logger.info(
                                        f"{p_udid}|||********************** FINISH TO CHECK FB GROUP {fb_group} *************************************")

                                # =================================== FIN [3.1.1] ========================================
                                logger.info(
                                    f"{p_udid}|||# ================ WE ARE OUT OF THE LOOP OF EACH GROUP =================")

                                logger.info(
                                    f"{p_udid}|||counter_Facebook_Share_posts_in_groups : {counter_Facebook_Share_posts_in_groups}/{p_quantity_share_groups} : p_quantity_share_groups")
                                # ===== 6th ==== We need to check if we reach the limit ==========================
                                if counter_Facebook_Share_posts_in_groups >= p_quantity_share_groups:
                                    logger.info(f"{p_udid}|||We reach the limited quantity of sharing post!")

                                    break
                                counter_round += 1
                                logger.info (f"{p_udid}|||counter_round : {counter_round}/{p_quantity_share_groups} : p_quantity_share_groups")

                                if counter_round >= p_quantity_share_groups:
                                    break

                            # ======================================= FIN [3.1] ===========================================
                            logger.info(
                                f"{p_udid}|||# ================ WE ARE OUT OF THE LOOP OF EACH POST =================")
                            logger.info(
                                f"{p_udid}|||counter_Facebook_Share_posts_in_groups : {counter_Facebook_Share_posts_in_groups}/{p_quantity_share_groups} : p_quantity_share_groups")
                            # ===== 6th ==== We need to check if we reach the limit ==========================
                            if counter_Facebook_Share_posts_in_groups >= p_quantity_share_groups:
                                logger.info(f"{p_udid}|||We reach the limited quantity of sharing post!")

                                break

                            counter_round+=1
                            logger.info (
                                f"{p_udid}|||counter_round : {counter_round}/{p_quantity_share_groups} : p_quantity_share_groups")
                            # ===== 6th ==== We need to check if we reach the limit ==========================

                            if counter_round >= p_quantity_share_groups:
                                break
                        # ======================================== FIN [3] ===============================================

                    else:
                        logger.info(
                            f"{p_udid}|||VERIFICATION 3 FAILED => You didn't fill the textarea 'List of posts' from 'Account details' for facebook account '{myprofile_username}'.")
                else:
                    logger.info(
                        f"{p_udid}|||VERIFICATION 2 FAILED => You didn't fill the textarea 'List of groups' from 'Account details' for facebook account '{myprofile_username}'.")
            else:
                logger.info(
                    f"{p_udid}|||VERIFICATION 1 FAILED => You didn't activate the option 'Share posts in Facebook groups' from 'Account details' for facebook account '{myprofile_username}'.")

        # ==============================================================================================================
        # ==============================================================================================================
        # ==============================================================================================================
        # ============================   Scrap, Add Friend & Send Message to Facebook Group Members   ==============================
        # ==============================================================================================================
        # ==============================================================================================================
        # ==============================================================================================================
        counter_Facebook_scrap = 0
        counter_Facebook_message = 0
        counter_Facebook_add_friend = 0






        if p_quantity_max_message !=0 or p_quantity_max_scrap!=0 or p_quantity_max_add_friend!=0 :

            if facebook_scrap_members_groups_pages == 1 or facebook_send_message == 1 or facebook_add_friend_from_group == 1:
                logger.info(
                    f"{p_udid}|||VERIFICATION 1 CORRECT => The options 'Scrap, Message & Add Friend' from 'Account details' are activated.")
                if facebook_list_groups_scrap_message != '':
                    logger.info(
                        f"{p_udid}|||VERIFICATION 2 CORRECT => The textarea 'List of groups' from 'Account details' is not empty.")
                    logger.info(
                        f"{p_udid}|||# =========== WE WILL PICKUP A GROUP RANDOMLY AND GO FOR EACH MEMBER OF THIS GROUP ============")
                    # =================================================================================
                    # =========================== PLAY STOP OR PAUSE ? ================================
                    # =================================================================================
                    mymodules.PlayStopPause(p_udid, 'Facebook Scrap,Add Friends & Send Messages')
                    # =================================================================================
                    # =================================================================================
                    # =================================================================================
                    # ==== Let's prepare list of groups:
                    facebook_list_groups_scrap_message = str(facebook_list_groups_scrap_message).split('\\n')
                    for group_of_list in facebook_list_groups_scrap_message:
                        if group_of_list == '':
                            facebook_list_groups_scrap_message.remove('')

                    logger.info(f"{p_udid}|||facebook_list_groups_scrap_message : {facebook_list_groups_scrap_message}")
                    quantity_groups = len(facebook_list_groups_scrap_message)
                    if quantity_groups == 1:
                        index_group = 0
                    else:
                        index_group = random.randint(0, quantity_groups - 1)
                    # html.unescape is to transform the html &amp; and others to '&' symbol.
                    facebook_group = html.unescape(facebook_list_groups_scrap_message[index_group])
                    logger.info(f"{p_udid}|||The group choosen is {facebook_group}.")
                    # ========================= PhoneBot picked up randomly a FB group ================================
                    # =================================================================================================
                    # =================================================================================================
                    # =================================================================================================


                    # =================================================================================================
                    # =================================================================================================
                    # =================================================================================================
                    # ================================== let's go in this group =======================================


                    logger.info(f"{p_udid}|||# =========== PhoneBot go in group {facebook_group} ====================")
                    group_found, member_of_group, element_group_name,p_bug = GoinFacebookGroup(driver, p_udid, facebook_group,myprofile_username,counter_Facebook_scrap,lock)
                    member_of_group=True
                    logger.info(f"{p_udid}|||group_found : {group_found}")
                    logger.info(f"{p_udid}|||member_of_group : {member_of_group}")
                    if group_found:
                        logger.info(f"{p_udid}|||VERIFICATION 3 CORRECT : group '{facebook_group}' was found!")
                        if member_of_group:
                            logger.info(
                                f"{p_udid}|||VERIFICATION 4 CORRECT : '{myprofile_username}' is member of '{facebook_group}'")
                            logger.info(f"{p_udid}|||PhoneBot is inside the group.")
                            logger.info(
                                f"{p_udid}|||The bot will sleep just a few seconds..............................")
                            time.sleep(random.uniform(3.9, 6.3))
                            driver.implicitly_wait(10)

                            # ========================= PhoneBot is inside the FB group ===============================
                            # =========================================================================================
                            # =========================================================================================
                            # =========================================================================================

                            # =========================================================================================
                            # =========================================================================================
                            # =========================================================================================
                            # ================= let's show the list of members of this group ==========================

                            # === Let go on list of members ========================================================
                            if element_group_name:  # element_group_name is the title of group name. If we click on it, we get the details page of groups where we can get the list of members
                                # =================================================================================
                                # =========================== PLAY STOP OR PAUSE ? ================================
                                # =================================================================================
                                mymodules.PlayStopPause(p_udid, 'Facebook going in Facebook group')
                                # =================================================================================
                                # =================================================================================
                                # =================================================================================
                                element_group_name.click()

                                logger.info(f"# ================================ WE ARE IN DETAIL PAGE OF GROUP =====================")
                                logger.info(
                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                time.sleep(random.uniform(3.9, 6.3))
                                driver.implicitly_wait(10)
                                # ================================ WE SCROLL 2 TIMES TO SEE 'See All' button ===================
                                mymodules.Scroll_Down(driver, p_udid, 2)
                                elements_of_group_detail_page = driver.find_elements_by_xpath("//*")
                                # group_found = False


                                # ========================= PhoneBot went in detail page of FB group ===============================
                                # =========================================================================================
                                # =========================================================================================
                                # =========================================================================================

                                # =========================================================================================
                                # =========================================================================================
                                # ============To display the list of members, we need to click on 'See All' button ===========
                                # ======== WE LOOP ALL THE ELEMENTS IN ODER TO GET AND CLICK ON THE 'See All' button =========
                                for element_of_group_detail_page in elements_of_group_detail_page:
                                    # =================================================================================
                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                    # =================================================================================
                                    mymodules.PlayStopPause(p_udid, 'Facebook search the "See All" button of FB group')
                                    # =================================================================================
                                    # =================================================================================
                                    # =================================================================================
                                    logger.info(
                                        f"{p_udid}|||PhoneBot go in the loop for each element of the group in order to find the name of group and the button 'Join group'.")
                                    content_desc = ''

                                    try:
                                        content_desc = str(element_of_group_detail_page.get_attribute('content-desc'))
                                    except:
                                        logger.info(f"{p_udid}|||There was no 'content-desc' for this element.")
                                    try:
                                        text = str(element_of_group_detail_page.get_attribute('text'))
                                    except:
                                        logger.info(f"{p_udid}|||There was no 'text' for this element.")
                                    if content_desc != '':
                                        logger.info(f"{p_udid}|||content_desc : {content_desc} - {type(content_desc)}")
                                        logger.info(
                                            f"{p_udid}|||PhoneBot found some 'content-desc'. Let's compare to '{facebook_group}'.")
                                        content_desc = unidecode.unidecode(content_desc)

                                        if str(content_desc).find('See All') != -1 or str(content_desc).find(
                                                'Voir tout') != -1:
                                            logger.info(f"{p_udid}|||!!!BINGO!!! content_desc : {content_desc}")
                                            logger.info(f"{p_udid}|||PhoneBot found 'See All' button")
                                            element_of_group_detail_page.click()
                                            break

                                logger.info(
                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                time.sleep(random.uniform(1.9, 3.3))
                                driver.implicitly_wait(10)
                                # ========================= PhoneBot found the 'See All' button =======================
                                # =====================================================================================
                                # =====================================================================================
                                # =====================================================================================

                                # =====================================================================================
                                # =====================================================================================
                                # =====================================================================================
                                # ==================== WE WILL OPEN MEMBER PROFILE PAGE OF EACH MEMBER =========================

                                index_member = 1
                                index_scroll = 9

                                headline = ''
                                gender = ''
                                job = ''
                                phone = ''
                                city = ''
                                country = ''
                                state = ''
                                email = ''
                                firstname = ''
                                lastname = ''
                                website = ''
                                linkedin = ''
                                pinterest = ''
                                twitter = ''
                                instagram = ''
                                we_are_in_full_profile = False
                                we_are_in_profile = False
                                    # --- We scroll down to the list of members -------------------------------------
                                mymodules.Scroll_Down_Small_medium(driver, p_udid, index_scroll)
                                cpt_of_members = 0
                                while True:
                                    # =================================================================================
                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                    # =================================================================================
                                    mymodules.PlayStopPause(p_udid, 'Facebook scrolling the list of members of Facebook group')
                                    # =================================================================================
                                    # =================================================================================
                                    # =================================================================================

                                    logger.info(
                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                    time.sleep(random.uniform(0.9, 2.3))
                                    driver.implicitly_wait(10)
                                    list_members = driver.find_elements_by_xpath(
                                        "//*[@class='androidx.recyclerview.widget.RecyclerView']/*[@class='android.view.ViewGroup']")

                                    try:
                                        #We need to be sure we can see a list of members...
                                        cpt=0
                                        while len(list_members) ==0:
                                            mymodules.Scroll_Down_Small_medium (driver, p_udid)
                                            list_button_member = driver.find_elements_by_xpath(
                                                "//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup/android.view.ViewGroup")
                                            cpt+=1
                                            if cpt>5:
                                                logger.critical(f"{p_udid}||| PhoneBot can't find a list of members in a group.")
                                                break
                                        if cpt > 5:
                                            logger.critical (
                                                f"{p_udid}||| PhoneBot can't find a list of members in a group.")
                                            break
                                        quantity_members = len(list_members)
                                        logger.info(f"{p_udid}|||quantity_members : {quantity_members}")
                                        logger.info(
                                            f"{p_udid}|||AT THE BEGINING OF THE LOOP OF MEMBERS DISPLAYED IN SCREEN =>index_member : {index_member}/{quantity_members - 1}")
                                        # ==============================================================================================
                                        # === We extract the fullname and header from the member of the list

                                        # === Sometimes, there are no button near to the member in the list of members of a group.
                                        # === So we have to check before if there are or not these buttons

                                        label_button = list_button_member[index_member].get_attribute("content-desc")
                                        print(f"label_button : {label_button}")
                                    except:
                                        label_button=''

                                    print(f"list_members[index_member] : {list_members[index_member]}")
                                    fullname, headlinegroup = mymodules.GetFacebookFullnameAndHeaderfromListMember(
                                        list_members[index_member], label_button)
                                    if fullname == '':
                                        logger.info(
                                            f"{p_udid}|||PhoneBot didn't succeed to extract fullname by OCR. It will skip this member.")
                                    else:
                                        # ============================================================================================
                                        # === 1rst We prepare Firstname and Lastname -------------------------------------------------
                                        fullname = fullname.replace('\u202a', '')
                                        list_fullname = fullname.split(" ")
                                        cpt = 1
                                        for element_fullname in list_fullname:
                                            print(f"element_fullname : {element_fullname}")
                                            if cpt == 1:
                                                firstname = str(element_fullname).capitalize()

                                            elif cpt == 2:
                                                lastname = str(element_fullname).capitalize()

                                            else:
                                                lastname += ' ' + str(element_fullname).capitalize()
                                            cpt += 1
                                        # === We get the flags of users
                                        logger.info(
                                            f"{p_udid}|||PhoneBot will check if '{fullname}' - '{headlinegroup}' exist in table 'contacts'.")
                                        id_contact_tuple = cursor1.execute(
                                            "SELECT id FROM contacts WHERE platform=? AND username=? AND facebook_headline_group=?",
                                            ('facebook', fullname, headlinegroup)).fetchone()
                                        if id_contact_tuple:
                                            id_contact = id_contact_tuple[0]
                                            logger.info(f"{p_udid}|||'{fullname}' already exist in table 'contacts'")

                                            # === We need to know if this contact was already scrapped, message, or added as friend
                                            if cursor1.execute(
                                                    "SELECT * FROM actions WHERE id_contact=? AND platform=? AND type_action=?",
                                                    (id_contact, 'facebook', 'scrap')).fetchone():
                                                logger.info(f"{p_udid}|||'{fullname}' was already 'scrapped'.")
                                                Flag_already_scrap = True
                                            else:
                                                Flag_already_scrap = False
                                            if cursor1.execute(
                                                    "SELECT * FROM actions WHERE id_contact=? AND platform=? AND type_action=?",
                                                    (id_contact, 'facebook', 'message_sent')).fetchone():
                                                logger.info(f"{p_udid}|||'{fullname}' already received a 'message'.")
                                                Flag_already_message = True
                                            else:
                                                Flag_already_message = False
                                            if cursor1.execute(
                                                    "SELECT * FROM actions WHERE id_contact=? AND platform=? AND type_action=?",
                                                    (id_contact, 'facebook', 'add_friend')).fetchone():
                                                logger.info(f"{p_udid}|||'{fullname}' was already 'added as friend'.")
                                                Flag_already_add_friend = True
                                            else:
                                                Flag_already_add_friend = False
                                            if cursor1.execute(
                                                    "SELECT * FROM contacts WHERE id=? AND type=?",
                                                    (id_contact, 'fb_page')).fetchone():
                                                logger.info(f"{p_udid}|||'{fullname}' is a Facebook Page.")
                                                Flag_is_fb_page = True
                                            else:
                                                Flag_is_fb_page = False
                                        else:
                                            Flag_already_scrap = False
                                            Flag_already_message = False
                                            Flag_already_add_friend = False
                                            Flag_is_fb_page = False
                                            with lock:
                                                cursor1.execute(
                                                    "INSERT INTO contacts (platform,username,first_name,last_name,facebook_group,facebook_headline_group) VALUES (?,?,?,?,?,?)",
                                                    ('facebook', fullname, firstname, lastname, facebook_group, headlinegroup))
                                                sqliteConnection.commit()
                                            id_contact_tuple = cursor1.execute(
                                                "SELECT id FROM contacts WHERE platform=? AND username=? AND facebook_headline_group=?",
                                                ('facebook', fullname, headlinegroup)).fetchone()
                                            id_contact = id_contact_tuple[0]

                                        logger.info(f"""{p_udid}|||
                                                                - Flag_already_scrap: {Flag_already_scrap}
                                                                - facebook_scrap_members_groups_pages: {facebook_scrap_members_groups_pages}
    
                                                                - Flag_already_message: {Flag_already_message}
                                                                - facebook_send_message: {facebook_send_message}
    
                                                                - Flag_already_add_friend: {Flag_already_add_friend}
                                                                - facebook_add_friend_from_group: {facebook_add_friend_from_group}
    
                                                                - Flag_is_fb_page = {Flag_is_fb_page}
                                                                """)

                                        # ================== PhoneBot check if the profile was already ================
                                        # ================== scrapped, added as friend, messaged ======================
                                        # =============================================================================
                                        # =============================================================================

                                        # =============================================================================
                                        # =============================================================================
                                        # =============================================================================
                                        # ================= WE will go on profile page if one of the task =============
                                        # ==================================== was not done ===========================

                                        if not Flag_is_fb_page:
                                            if (facebook_scrap_members_groups_pages == 1 and not Flag_already_scrap) or (
                                                    facebook_send_message == 1 and not Flag_already_message) or (
                                                    facebook_add_friend_from_group == 1 and not Flag_already_add_friend):

                                                # =====================================================================
                                                # ======================= GO TO PROFILE PAGE ==========================
                                                # =====================================================================

                                                # =================================================================================
                                                # =========================== PLAY STOP OR PAUSE ? ================================
                                                # =================================================================================
                                                mymodules.PlayStopPause(p_udid, 'Facebook Go to profile page')
                                                # =================================================================================
                                                # =================================================================================
                                                # =================================================================================

                                                logger.info(
                                                    f"{p_udid}|||# ====== WE GO ON PROFILE PAGE index_member:{index_member}/{quantity_members - 1} ===")

                                                list_members[index_member].click()
                                                logger.info(
                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                time.sleep(random.uniform(2.9, 5.3))
                                                driver.implicitly_wait(10)
                                                # =========================================================================================
                                                logger.info(f"{p_udid}||| =======  CHECK THE PHOTO OF PROFILE TO KNOW IF WE ARE REALLY ON PROFILE PAGE =============")

                                                we_are_in_profile = CheckIfWeAreInProfile(driver, p_udid)
                                                we_are_in_list = WeAreInListMembers(driver)

                                                # === It can happen so many bugs. We need to be sure we are in profile page and not somewhere else.
                                                # === If we are NOT in profile page and we are not in the list, we GO BACK
                                                if not we_are_in_profile:
                                                    if not we_are_in_list:
                                                        GoBackButtonFacebook(driver, p_udid)
                                                else:
                                                    logger.info(
                                                        f"{p_udid}|||# ================= WE CLICK ON 'Plus' BUTTON TO SEE FULL PROFILE PAGE ===========")


                                                    try:
                                                        plus_button = driver.find_elements_by_xpath(
                                                            "//android.view.ViewGroup[@content-desc='Plus']")
                                                        plus_button[0].click()
                                                    except:
                                                        try:
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot didn't find the French 'Plus' button. Let's search for English one")
                                                            plus_button = driver.find_elements_by_xpath(
                                                                "//android.view.ViewGroup[@content-desc='More']")
                                                            plus_button[0].click()
                                                        except:
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot didn't find the English 'More' button. We skip this profile!")


                                                    logger.info(
                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                    time.sleep(random.uniform(0.9, 1.3))
                                                    driver.implicitly_wait(5)

                                                    # ==============================================================================================
                                                    logger.info(
                                                        f"{p_udid}|||# ================= WE CLICK ON 'See Main Profile' button ===========")
                                                    see_full_profile = driver.find_element_by_xpath(
                                                        "//*[@class='androidx.recyclerview.widget.RecyclerView']/*[@class='android.view.ViewGroup']")
                                                    see_full_profile.click()
                                                    logger.info(
                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                    time.sleep(random.uniform(2.9, 5.3))
                                                    driver.implicitly_wait(10)

                                                    # === Let's also check that it is not a Facebook page ------------------------------------


                                                    try:
                                                        like_button = driver.find_element_by_xpath(
                                                            "//android.view.ViewGroup[@content-desc='bouton J’aime']")
                                                        logger.info(f"{p_udid}|||Facebook is in a Facebook Page!")
                                                        we_are_in_page = True
                                                    except:
                                                        try:
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot didn't find the French 'Like' button. Let's search for English one")
                                                            like_button = driver.find_element_by_xpath(
                                                                "//android.view.ViewGroup[@content-desc='like button']")
                                                            logger.info(f"{p_udid}|||Facebook is in a Facebook Page!")
                                                            we_are_in_page = True
                                                        except:
                                                            try:
                                                                logger.info(
                                                                    f"{p_udid}|||PhoneBot didn't find the English 'Like' button. We will check other stuff to be sure! :-)")
                                                                menu_fb_page = driver.find_element_by_xpath(
                                                                    "//*[@class='android.widget.TextView' and contains(@content-desc, 'Home, Tab 1')]")
                                                                logger.info(
                                                                    f"{p_udid}|||Facebook is in a Facebook Page!")
                                                                we_are_in_page = True
                                                            except:
                                                                try:
                                                                    logger.info(
                                                                        f"{p_udid}|||PhoneBot didn't find the English Home button button. Let's search for French one")
                                                                    menu_fb_page = driver.find_element_by_xpath(
                                                                        "//*[@class='android.widget.TextView' and contains(@content-desc, 'Onglet Home, 1 sur')]")
                                                                    logger.info(
                                                                        f"{p_udid}|||Facebook is in a Facebook Page!")
                                                                    we_are_in_page = True
                                                                except:
                                                                    logger.info(
                                                                        f"{p_udid}|||PhoneBot didn't find the English Home button button. We are on profile page for sure! :-)")
                                                                    we_are_in_page = False


                                                    # ============== PhoneBot went to 'See main profile' ==============
                                                    # ============= and checked that it is not a FB page  =============
                                                    # =================================================================
                                                    # =================================================================

                                                    # =================================================================
                                                    # =================================================================
                                                    # =================================================================
                                                    # ======== WE will search for the full name of profile ============

                                                    if not we_are_in_page:
                                                        # =================================================================================
                                                        # =========================== PLAY STOP OR PAUSE ? ================================
                                                        # =================================================================================
                                                        mymodules.PlayStopPause(p_udid, 'Facebook Search for full name')
                                                        # =================================================================================
                                                        # =================================================================================
                                                        # =================================================================================

                                                        # ==============================================================================================
                                                        logger.info(
                                                            f"{p_udid}|||# ================= WE SEARCH FOR FULLNAME ELEMENT ======================")
                                                        try:
                                                            fullname_elements = driver.find_elements_by_xpath(
                                                                "//android.view.ViewGroup[@content-desc='Message']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[2]/android.view.ViewGroup")
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot found the fullname of member! :-)")
                                                            text_brut_fullname = mymodules.GetTextfromScreenshot(driver,
                                                                                                                 p_udid,
                                                                                                                 fullname_elements[
                                                                                                                     0])
                                                            logger.info(
                                                                f"{p_udid}|||************* text_fullname : {text_brut_fullname} *************************")
                                                            fullname = mymodules.CleanOCRText(text_brut_fullname)
                                                        except:
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot didn't find the fullname of member. We have to skip him/her! :-(")


                                                        # ==============================================================================================
                                                        logger.info(
                                                            f"{p_udid}|||# ================= WE SEARCH FOR HEADLINE ELEMENT ======================")
                                                        try:
                                                            headline_elements = driver.find_elements_by_xpath(
                                                                "//android.view.ViewGroup[@content-desc='Message']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[1]/android.view.ViewGroup")
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot found the headline of member! :-)")
                                                            text_brut_headline = mymodules.GetTextfromScreenshot(driver,
                                                                                                                 p_udid,
                                                                                                                 headline_elements[
                                                                                                                     0])
                                                            logger.info(
                                                                f"{p_udid}|||************* text_brut_headline : {text_brut_headline} *************************")
                                                            headline = mymodules.CleanOCRText(text_brut_headline)
                                                        except:
                                                            logger.info(
                                                                f"{p_udid}|||PhoneBot didn't find the headline. We have to skip the headline :-(")



                                                        # ==============================================================================================
                                                        # ======================== WE SAVE THE fullname & headline IN TABLE 'contacts' =================
                                                        # =============== BECAUSE Scrap, Send meesage and Add friend will need an id_contact  ==========
                                                        # ================================== FOR INSERTING IN TABLE 'actions' ==========================
                                                        # ==============================================================================================

                                                        # ==============================================================================================
                                                        # ===================================== WE START THE SCRAPING ==================================
                                                        # ==============================================================================================


                                                        if p_quantity_max_scrap!=0:

                                                            if facebook_scrap_members_groups_pages == 1 and not Flag_already_scrap:
                                                                if counter_Facebook_scrap < p_quantity_max_scrap:
                                                                    # =================================================================================
                                                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                                                    # =================================================================================
                                                                    mymodules.PlayStopPause(p_udid,
                                                                                            'Facebook Start Scraping profile')
                                                                    # =================================================================================
                                                                    # =================================================================================
                                                                    # =================================================================================
                                                                    logger.info(
                                                                        f"{p_udid}|||# ======================== WE START THE SCRAPING {fullname} ==========================")
                                                                    # === 1rst We need to click on '... See more info...'. But we will scroll down a bit to be sure to see this"

                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(0.8, 1.3))
                                                                    driver.implicitly_wait(5)
                                                                    see_more = ''
                                                                    index_scroll_scrap = 0
                                                                    while len(see_more) == 0:
                                                                        # =================================================================================
                                                                        # =========================== PLAY STOP OR PAUSE ? ================================
                                                                        # =================================================================================
                                                                        mymodules.PlayStopPause(p_udid,
                                                                                                'Facebook Scraping profile')
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        mymodules.Scroll_Down_small(driver, p_udid)
                                                                        try:
                                                                            see_more = driver.find_elements_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='Amis']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[3]")
                                                                            if (str(see_more[0].get_attribute(
                                                                                    'content-desc')).lower()).find(
                                                                                'section') != -1:
                                                                                logger.info(
                                                                                    f"{p_udid}|||This is not the '...See more...' button. It is pictures.")
                                                                                see_more = driver.find_elements_by_xpath(
                                                                                    "//android.view.ViewGroup[@content-desc='Amis']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[4]")
                                                                            elif (str(see_more[0].get_attribute(
                                                                                    'content-desc')).lower()).find(
                                                                                'collection') != -1:
                                                                                logger.info(
                                                                                    f"{p_udid}|||This is not the '...See more...' button. It is pictures.")
                                                                                see_more = driver.find_elements_by_xpath(
                                                                                    "//android.view.ViewGroup[@content-desc='Friends']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[5]")

                                                                            see_more[0].click()
                                                                            we_are_in_full_profile = True
                                                                            break

                                                                        except:
                                                                            try:
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot didn't find the French '... See more info...' button. Let's search for English one")
                                                                                see_more = driver.find_elements_by_xpath(
                                                                                    "//android.view.ViewGroup[@content-desc='Friends']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[3]")
                                                                                if (str(see_more[0].get_attribute('content-desc')).lower()).find('section') != -1:

                                                                                    logger.info(
                                                                                        f"{p_udid}|||This is not the '...See more...' button. It is pictures.")
                                                                                    see_more = driver.find_elements_by_xpath(
                                                                                        "//android.view.ViewGroup[@content-desc='Friends']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[4]")

                                                                                elif (str(see_more[0].get_attribute('content-desc')).lower()).find('featured') != -1:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||This is not the '...See more...' button. It is pictures.")
                                                                                    see_more = driver.find_elements_by_xpath(
                                                                                        "//android.view.ViewGroup[@content-desc='Friends']/parent::android.view.ViewGroup[1]/preceding-sibling::android.view.ViewGroup[5]")
                                                                                see_more[0].click()
                                                                                we_are_in_full_profile = True
                                                                                break

                                                                            except:
                                                                                mymodules.Scroll_Down_small(driver, p_udid)
                                                                                index_scroll_scrap += 1
                                                                                if index_scroll_scrap > 15:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||PhoneBot didn't find the English '... See more info...' button. We skip this profile!")
                                                                                    we_are_in_full_profile = False
                                                                                    break


                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(1.9, 3.3))
                                                                    driver.implicitly_wait(10)

                                                                    # === 2nd, If we are in full profile, we do the scraping -----------------------------------
                                                                    if we_are_in_full_profile:


                                                                        logger.info(
                                                                            f"{p_udid}|||PhoneBot is in full profile and will scrap all the details.")
                                                                        logger.info(
                                                                            f"{p_udid}|||# =================== Let's see the values of all the variables ==============")
                                                                        print(f"gender : {gender} - {type(gender)}")
                                                                        print(f"job : {job} - {type(job)}")
                                                                        print(f"phone : {phone} - {type(phone)}")
                                                                        print(f"city : {city} - {type(city)}")
                                                                        print(f"country : {country} - {type(country)}")
                                                                        print(f"state : {state} - {type(state)}")
                                                                        print(f"email : {email} - {type(email)}")
                                                                        print(f"firstname : {firstname} - {type(firstname)}")
                                                                        print(f"lastname : {lastname} - {type(lastname)}")
                                                                        print(f"website : {website} - {type(website)}")
                                                                        print(f"linkedin : {linkedin} - {type(linkedin)}")
                                                                        print(f"pinterest : {pinterest} - {type(pinterest)}")
                                                                        print(f"twitter : {twitter} - {type(twitter)}")

                                                                        while True:
                                                                            # =================================================================================
                                                                            # =========================== PLAY STOP OR PAUSE ? ================================
                                                                            # =================================================================================
                                                                            mymodules.PlayStopPause(p_udid,
                                                                                                    'Facebook Start Scraping profile')
                                                                            # =================================================================================
                                                                            # =================================================================================
                                                                            # =================================================================================
                                                                            list_of_elements = driver.find_elements_by_class_name(
                                                                                "android.widget.TextView")
                                                                            while len(list_of_elements)==0:
                                                                                mymodules.Scroll_Down_Small_medium(
                                                                                    driver, p_udid, 1)
                                                                                list_of_elements = driver.find_elements_by_class_name(
                                                                                    "android.widget.TextView")
                                                                                logger.info(
                                                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                                time.sleep(random.uniform(1.9, 3.3))
                                                                                driver.implicitly_wait(5)


                                                                            if website == '':
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE WEBSITE =====================================================")
                                                                                try:
                                                                                    websites = driver.find_element_by_xpath(
                                                                                        "//android.widget.TextView[@text='Website']/preceding-sibling::android.widget.TextView[1]")

                                                                                    try:
                                                                                        like_section = driver.find_element_by_xpath(
                                                                                        "//android.widget.TextView[@text='Website']/../../../../..//android.widget.TextView[@text='Likes']")

                                                                                    except:
                                                                                        website = websites.get_attribute('text')
                                                                                except:
                                                                                    try:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find English website. :-(")
                                                                                        websites = driver.find_element_by_xpath(
                                                                                            "//android.widget.TextView[@text='Site web']/preceding-sibling::android.widget.TextView[1]")
                                                                                        try:
                                                                                            like_section = driver.find_element_by_xpath(
                                                                                                "//android.widget.TextView[@text='Site web']/../../../../..//android.widget.TextView[@text='Mentions J’aime']")

                                                                                        except:
                                                                                            website = websites.get_attribute('text')

                                                                                    except:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find French website. :-(")

                                                                            if city == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE CITY =====================================================")

                                                                                try:
                                                                                    cities = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Current city']/preceding-sibling::android.widget.TextView[1]")
                                                                                    city = cities[0].get_attribute('text')
                                                                                    list_city = city.split(', ')
                                                                                    try:
                                                                                        city = list_city[0]
                                                                                    except:
                                                                                        city=''
                                                                                    try:
                                                                                        state = list_city[1]
                                                                                    except:
                                                                                        state = ''
                                                                                    try:
                                                                                        country = list_city[2]
                                                                                    except:
                                                                                        country=''

                                                                                except:
                                                                                    try:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find English city. :-(")
                                                                                        cities = driver.find_elements_by_xpath(
                                                                                            "//android.widget.TextView[@text='Ville actuelle']/preceding-sibling::android.widget.TextView[1]")

                                                                                        city = cities[0].get_attribute(
                                                                                            'text')
                                                                                        list_city = city.split(', ')
                                                                                        try:
                                                                                            city = list_city[0]
                                                                                        except:
                                                                                            city = ''
                                                                                        try:
                                                                                            state = list_city[1]
                                                                                        except:
                                                                                            state = ''
                                                                                        try:
                                                                                            country = list_city[2]
                                                                                        except:
                                                                                            country = ''

                                                                                    except:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find French city. :-(")

                                                                            if job == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE JOB =====================================================")
                                                                                try:
                                                                                    jobs = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Work']/../../../following-sibling::android.view.ViewGroup[1]//android.widget.TextView)[1]")

                                                                                    job = jobs[0].get_attribute('text')
                                                                                except:
                                                                                    try:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find English work. :-(")
                                                                                        jobs = driver.find_elements_by_xpath(
                                                                                            "//android.widget.TextView[@text='Emploi']/../../../following-sibling::android.view.ViewGroup[1]//android.widget.TextView)[1]")
                                                                                        job = jobs[0].get_attribute('text')

                                                                                    except:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find French work. :-(")

                                                                            if gender == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE GENDER =====================================================")
                                                                                try:
                                                                                    genders = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Gender']/preceding-sibling::android.widget.TextView[1]")

                                                                                    gender = genders[0].get_attribute(
                                                                                        'text')
                                                                                except:
                                                                                    try:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find English gender. :-(")
                                                                                        genders = driver.find_elements_by_xpath(
                                                                                            "//android.widget.TextView[@text='Genre']/preceding-sibling::android.widget.TextView[1]")

                                                                                        gender = genders[0].get_attribute('text')
                                                                                    except:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find French gender. :-(")

                                                                            if phone == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE PHONE =====================================================")
                                                                                try:
                                                                                    phones = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Mobile']/preceding-sibling::android.widget.TextView[1]")

                                                                                    phone = phones[0].get_attribute(
                                                                                        'text')

                                                                                except:
                                                                                    try:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find English phone. :-(")
                                                                                        phones = driver.find_elements_by_xpath(
                                                                                            "//android.widget.TextView[@text='Téléphone']/preceding-sibling::android.widget.TextView[1]")

                                                                                        phone = phones[0].get_attribute(
                                                                                            'text')

                                                                                    except:
                                                                                        logger.info(
                                                                                            f"{p_udid}|||PhoneBot didn't find French phone. :-(")

                                                                            if instagram == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE INSTAGRAM =====================================================")
                                                                                try:
                                                                                    instagrams = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Instagram']/preceding-sibling::android.widget.TextView[1]")

                                                                                    instagram = instagrams[0].get_attribute('text')
                                                                                except:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||PhoneBot didn't find instagram. :-(")

                                                                            if twitter == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE TWITTER =====================================================")
                                                                                try:
                                                                                    twitters = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Twitter']/preceding-sibling::android.widget.TextView[1]")
                                                                                    twitter = twitters[0].get_attribute('text')


                                                                                except:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||PhoneBot didn't find twitter. :-(")

                                                                            if linkedin == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE LINKEDIN =====================================================")
                                                                                try:
                                                                                    linkedins = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Linkedin']/preceding-sibling::android.widget.TextView[1]")
                                                                                    linkedin = linkedins[0].get_attribute('text')

                                                                                except:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||PhoneBot didn't find Linkedin. :-(")

                                                                            if email == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE EMAIL =====================================================")
                                                                                try:
                                                                                    emails = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Email']/preceding-sibling::android.widget.TextView[1]")
                                                                                    email = emails[0].get_attribute(
                                                                                        'text')

                                                                                except:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||PhoneBot didn't find Email. :-(")

                                                                            if pinterest == '':
                                                                                # ==========================================================================
                                                                                logger.info(
                                                                                    f"{p_udid}|||# === SCRAP THE PINTEREST =====================================================")
                                                                                try:
                                                                                    pinterests = driver.find_elements_by_xpath(
                                                                                        "//android.widget.TextView[@text='Pinterest']/preceding-sibling::android.widget.TextView[1]")
                                                                                    pinterest = pinterests[
                                                                                        0].get_attribute('text')

                                                                                except:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||PhoneBot didn't find pinterest. :-(")

                                                                                    # ==========================================================================

                                                                            mymodules.Scroll_Down(driver, p_udid)
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot will sleep just a few seconds..............................")
                                                                            time.sleep(random.uniform(1.9, 3.3))
                                                                            driver.implicitly_wait(10)
                                                                            new_list_of_elements = driver.find_elements_by_class_name(
                                                                                "android.widget.TextView")
                                                                            text_new_list_of_elements = []
                                                                            for element in new_list_of_elements:
                                                                                try:
                                                                                    text_new_list_of_elements.append(
                                                                                        element.get_attribute('text'))
                                                                                except:
                                                                                    print("no text attribute")
                                                                            text_list_of_elements = []
                                                                            for element in list_of_elements:
                                                                                try:
                                                                                    text_list_of_elements.append(
                                                                                        element.get_attribute('text'))
                                                                                except:
                                                                                    print("no text attribute")
                                                                            if text_new_list_of_elements == text_list_of_elements:
                                                                                logger.info(
                                                                                    f"{p_udid}|||#PhoneBot scrap it all. We can exit the detail page.")
                                                                                break
                                                                            else:
                                                                                logger.info(
                                                                                    f"{p_udid}|||#PhoneBot didn't scrap it all. We continue.")
                                                                                print(
                                                                                    f"text_new_list_of_elements : {text_new_list_of_elements}")
                                                                                print(
                                                                                    f"text_list_of_elements : {text_list_of_elements}")

                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot scroll the full detail page and will sleep just a few seconds..............................")
                                                                            time.sleep(random.uniform(1.9, 3.3))
                                                                            driver.implicitly_wait(10)

                                                                        GoBackButtonFacebook(driver, p_udid)

                                                                    url_facebook = ''

                                                                    # === 3rd We need to click on the 3 dots '...' button in order to scrap profile url.
                                                                    try:

                                                                        view_more = driver.find_elements_by_xpath(
                                                                            "//android.view.ViewGroup[@content-desc='More']")
                                                                        logger.info(
                                                                            f"{p_udid}|||PhoneBot found the English button 'More'.")
                                                                        view_more[0].click()
                                                                        we_are_in_view_more = True

                                                                    except:
                                                                        try:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the English button 'More'. Let's search for the French one.")
                                                                            view_more = driver.find_elements_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='Plus']")
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot found the French button 'Plus'.")
                                                                            view_more[0].click()
                                                                            we_are_in_view_more = True

                                                                        except:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the French button 'Plus'. We skip this part")
                                                                            we_are_in_view_more = False



                                                                        logger.info(
                                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                        time.sleep(random.uniform(0.9, 2.3))
                                                                        driver.implicitly_wait(5)

                                                                    if we_are_in_view_more:
                                                                        element_url_profile = ''
                                                                        try:
                                                                            copy_link = driver.find_element_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='COPY LINK']")
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot found the English 'COPY LINK'.")
                                                                            element_url_profile = driver.find_element_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='COPY LINK']/parent::android.view.ViewGroup")
                                                                        except:
                                                                            try:
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot didn't find the English 'COPY LINK'. Let's search for the French one.")
                                                                                copy_link = driver.find_element_by_xpath(
                                                                                    "//android.view.ViewGroup[@content-desc='COPIER LE LIEN']")
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot found the French 'COPIER LE LIEN'.")
                                                                                element_url_profile = driver.find_element_by_xpath(
                                                                                    "//android.view.ViewGroup[@content-desc='COPIER LE LIEN']/parent::android.view.ViewGroup")

                                                                            except:
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot didn't find the French 'COPIER LE LIEN'. We skip this part")


                                                                        if element_url_profile != '':

                                                                            textOCR = mymodules.GetTextfromScreenshot(driver,p_udid,element_url_profile)
                                                                            list_textOCR = textOCR.split('\n')
                                                                            print(list_textOCR)

                                                                            for element in list_textOCR:
                                                                                if element.find('https://') != -1:
                                                                                    url_facebook = element

                                                                            logger.info(
                                                                                f"{p_udid}|||url_facebook : {url_facebook}")

                                                                        GoBackButtonFacebook(driver, p_udid)

                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(0.9, 2.3))
                                                                    driver.implicitly_wait(5)

                                                                    logger.info(
                                                                        f"{p_udid}|||# =================== WE INSERT PROFILE IN TABLE 'contacts' & 'actions' ==============")
                                                                    print(f"gender : {gender} - {type(gender)}")
                                                                    print(f"job : {job} - {type(job)}")
                                                                    print(f"phone : {phone} - {type(phone)}")
                                                                    print(f"city : {city} - {type(city)}")
                                                                    print(f"country : {country} - {type(country)}")
                                                                    print(f"state : {state} - {type(state)}")
                                                                    print(f"email : {email} - {type(email)}")
                                                                    print(f"firstname : {firstname} - {type(firstname)}")
                                                                    print(f"lastname : {lastname} - {type(lastname)}")
                                                                    print(f"website : {website} - {type(website)}")
                                                                    print(f"linkedin : {linkedin} - {type(linkedin)}")
                                                                    print(f"pinterest : {pinterest} - {type(pinterest)}")
                                                                    print(f"twitter : {twitter} - {type(twitter)}")

                                                                    if id_contact:
                                                                        print(f"id_contact : {id_contact} - {type(id_contact)}")
                                                                        logger.info(
                                                                            f"{p_udid}|||'{fullname}' already exist in table 'contacts'. We will update the table.")
                                                                        with lock:
                                                                            cursor1.execute("UPDATE contacts set gender=?, job=?, phone=?, city=?, country=?, state=?,  \
                                                                                                                                            email=?, first_name=?, last_name=?, website=?, url_linkedin=?, pinterest=?,  \
                                                                                                                                            twitter=?, facebook_headline_group=?, url_facebook=? WHERE id=?",
                                                                                            (gender, job, phone, city, country,
                                                                                             state,
                                                                                             email, firstname, lastname, website,
                                                                                             linkedin,
                                                                                             pinterest, twitter, headlinegroup,
                                                                                             url_facebook,
                                                                                             id_contact))
                                                                            sqliteConnection.commit()
                                                                        now = datetime.now()
                                                                        date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))

                                                                        with lock:
                                                                            cursor1.execute(
                                                                                "INSERT INTO actions (platform,type_action,id_contact,id_smartphone,date,id_social_account,fb_group_name) VALUES(?,?,?,?,?,?,?)",
                                                                                ('facebook', 'scrap', id_contact, p_udid,
                                                                                 date_n_time,
                                                                                 myprofile_username,facebook_group))
                                                                            sqliteConnection.commit()
                                                                            counter_Facebook_scrap += 1

                                                                    else:
                                                                        logger.info(
                                                                            f"{p_udid}|||'{fullname}' doesn't exist in table 'contacts'. PhoneBot will INSERT it.")
                                                                        with lock:
                                                                            cursor1.execute(
                                                                                "INSERT INTO contacts (platform,username,first_name,last_name,facebook_headline,gender, job, phone, city, country, state,  \
                                                                                            email, firstname, lastname, website, url_linkedin, pinterest,  \
                                                                                            twitter,facebook_group,facebook_headline_group,url_facebook) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",
                                                                                (
                                                                                'facebook', fullname, firstname, lastname, headline,
                                                                                gender, job, phone, city,
                                                                                country, state,
                                                                                email, website, linkedin, pinterest, twitter,
                                                                                facebook_group,
                                                                                headlinegroup, url_facebook))
                                                                            sqliteConnection.commit()
                                                                        id_contact_tuple = cursor1.execute(
                                                                            "SELECT id FROM contacts WHERE platform=? AND username=? AND facebook_headline_group=?",
                                                                            ('facebook', fullname, headlinegroup)).fetchone()
                                                                        id_contact = id_contact_tuple[0]
                                                                        print(f"id_contact : {id_contact} - {type(id_contact)}")
                                                                        now = datetime.now()
                                                                        date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                                        with lock:
                                                                            cursor1.execute(
                                                                                "INSERT INTO actions (platform,type_action,id_contact,id_smartphone,date,id_social_account,fb_group_name) VALUES(?,?,?,?,?,?,?)",
                                                                                ('facebook', 'scrap', id_contact, p_udid,
                                                                                 date_n_time,
                                                                                 myprofile_username,facebook_group))
                                                                            sqliteConnection.commit()
                                                                        counter_Facebook_scrap += 1
                                                                        logger.info(
                                                                            f"{p_udid}|||counter_Facebook_scrap : {counter_Facebook_scrap} / {p_quantity_max_scrap}")

                                                                else:
                                                                    logger.info(
                                                                        f"{p_udid}|||# PhoneBot reach the maximum limit of scraping profiles : {counter_Facebook_scrap}/{p_quantity_max_scrap}")

                                                            else:
                                                                logger.info(
                                                                    f"{p_udid}|||# You didn't activate the option 'Scrap profile of Group member' or this profile was already scrapped  in 'Account Details' on https://phonebot.co")
                                                                counter_Facebook_scrap = p_quantity_max_scrap

                                                        # ==============================================================================================
                                                        # ===================================== WE START TO ADD FRIEND =================================
                                                        # ==============================================================================================


                                                        if p_quantity_max_add_friend!=0:

                                                            if facebook_add_friend_from_group == 1 and not Flag_already_add_friend:
                                                                if counter_Facebook_add_friend < p_quantity_max_add_friend:
                                                                    # =================================================================================
                                                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                                                    # =================================================================================
                                                                    mymodules.PlayStopPause(p_udid,
                                                                                            'Facebook Start Add Friends')
                                                                    # =================================================================================
                                                                    # =================================================================================
                                                                    # =================================================================================
                                                                    logger.info(
                                                                        f"{p_udid}|||# ======================== WE START TO ADD FIREND {fullname} ==========================")
                                                                    logger.info(
                                                                        f"{p_udid}|||# === We click on 'Add friend' button ----------------------")
                                                                    try:
                                                                        add_friend_button = driver.find_elements_by_xpath(
                                                                            "//android.view.ViewGroup[@content-desc='Ajouter']")
                                                                        logger.info(
                                                                            f"{p_udid}|||PhoneBot found the French 'Ajouter' button.")
                                                                        add_friend_button[0].click()
                                                                    except:
                                                                        try:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the French 'Ajouter' button. Let's search for the French one.")
                                                                            add_friend_button = driver.find_elements_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='Add']")
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot found the English 'Add' button.")
                                                                            add_friend_button[0].click()
                                                                        except:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the English 'Ajouter' button. We skip this part")


                                                                    logger.info(
                                                                        f"{p_udid}|||# ===========  WE UPDATE DATABASE TO INSERT 'add_friend' IN 'actions' table =========")
                                                                    now = datetime.now()
                                                                    date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                                    with lock:
                                                                        cursor1.execute("INSERT INTO actions (platform,type_action,date,id_smartphone,id_social_account,id_contact,fb_group_name)  VALUES (?,?,?,?,?,?,?)",
                                                                                        ('facebook',
                                                                                         'add_friend', date_n_time, p_udid,
                                                                                         myprofile_username,
                                                                                         id_contact,facebook_group))
                                                                        sqliteConnection.commit()
                                                                        counter_Facebook_add_friend += 1
                                                                    #GoBackButtonFacebook(driver, p_udid)

                                                                    # === We need to check if a popup  "Votre invitation est en route" is open or no
                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(1.9, 3.3))
                                                                    driver.implicitly_wait(10)

                                                                    try:
                                                                        close_popup_button= driver.find_elements_by_xpath("//android.widget.ImageView[@content-desc='Fermer']")

                                                                        logger.info(f"{p_udid}||| There is the popup 'Your invitation is on its way'. PhoneBot will close it by clicking button 'Fermer'.")
                                                                        close_popup_button[0].click()
                                                                        logger.info(
                                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                        time.sleep(random.uniform(1.9, 3.3))
                                                                        driver.implicitly_wait(10)
                                                                    except:
                                                                        try:
                                                                            close_popup_button = driver.find_elements_by_xpath(
                                                                                "//android.widget.ImageView[@content-desc='Close']")

                                                                            logger.info(
                                                                                f"{p_udid}||| There is the popup 'Your invitation is on its way'. PhoneBot will close it by clicking button 'Close'.")
                                                                            close_popup_button[0].click()
                                                                            logger.info(
                                                                                f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                            time.sleep(random.uniform(1.9, 3.3))
                                                                            driver.implicitly_wait(10)
                                                                        except:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the popup 'Your invitation is on its way'.")
                                                                    # ======================================================================================================



                                                                else:
                                                                    logger.info(
                                                                        f"{p_udid}|||# PhoneBot reach the maximum limit of Adding Friends : {counter_Facebook_add_friend}/{p_quantity_max_add_friend}")
                                                            else:
                                                                logger.info(
                                                                    f"{p_udid}|||# You didn't activate the option 'Add Friend the Group member' in 'Account Details' on https://phonebot.co")
                                                                counter_Facebook_add_friend = p_quantity_max_add_friend

                                                        # ==============================================================================================
                                                        # ===================================== WE START TO SEND MESSAGE ===============================
                                                        # ==============================================================================================

                                                        we_are_in_group = False
                                                        # ==== Before to start the other tasks we need to scroll up:
                                                        cpt = 1

                                                        if p_quantity_max_message!=0:

                                                            while True:
                                                                # =================================================================================
                                                                # =========================== PLAY STOP OR PAUSE ? ================================
                                                                # =================================================================================
                                                                mymodules.PlayStopPause(p_udid,
                                                                                        'Facebook Send message')
                                                                # =================================================================================
                                                                # =================================================================================
                                                                # =================================================================================
                                                                mymodules.Scroll_Up(driver, p_udid)
                                                                we_are_in_profile = CheckIfWeAreInProfile(driver, p_udid)
                                                                cpt += 1
                                                                if we_are_in_profile:
                                                                    break
                                                                elif cpt > 2:
                                                                    group_found, member_of_group, element_group_name,p_bug = GoinFacebookGroup(
                                                                        driver, p_udid, facebook_group, myprofile_username,counter_Facebook_message,lock)

                                                                    Flag_already_message = True
                                                                    element_group_name.click()
                                                                    # ================================ WE ARE INN DETAIL PAGE OF GROUP =====================
                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(1.9, 3.3))
                                                                    driver.implicitly_wait(10)
                                                                    # ================================ WE SCROLL 2 TIMES TO SEE 'See All' button ===================
                                                                    mymodules.Scroll_Down(driver, p_udid, 2)
                                                                    elements_of_group_detail_page = driver.find_elements_by_xpath(
                                                                        "//*")
                                                                    # group_found = False

                                                                    # ============ WE LOOP ALL THE ELEMENTS IN ODER TO GET AND CLICK ON THE 'See All' button =========
                                                                    for element_of_group_detail_page in elements_of_group_detail_page:
                                                                        # =================================================================================
                                                                        # =========================== PLAY STOP OR PAUSE ? ================================
                                                                        # =================================================================================
                                                                        mymodules.PlayStopPause(p_udid,
                                                                                                'Facebook Send message')
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        logger.info(
                                                                            f"{p_udid}|||PhoneBot go in the loop for each element of the group in order to find the name of group and the button 'Join group'.")
                                                                        content_desc = ''

                                                                        try:
                                                                            content_desc = str(
                                                                                element_of_group_detail_page.get_attribute(
                                                                                    'content-desc'))
                                                                        except:
                                                                            logger.info(
                                                                                f"{p_udid}|||There was no 'content-desc' for this element.")
                                                                        try:
                                                                            text = str(
                                                                                element_of_group_detail_page.get_attribute(
                                                                                    'text'))
                                                                        except:
                                                                            logger.info(
                                                                                f"{p_udid}|||There was no 'text' for this element.")
                                                                        if content_desc != '':
                                                                            logger.info(
                                                                                f"{p_udid}|||content_desc : {content_desc} - {type(content_desc)}")
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot found some 'content-desc'. Let's compare to '{facebook_group}'.")
                                                                            content_desc = unidecode.unidecode(content_desc)

                                                                            if str(content_desc).find('See All') != -1 or str(
                                                                                    content_desc).find('Voir tout') != -1:
                                                                                logger.info(
                                                                                    f"{p_udid}|||!!!BINGO!!! content_desc : {content_desc}")
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot found 'See All' button")
                                                                                element_of_group_detail_page.click()
                                                                                break

                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(1.9, 3.3))
                                                                    driver.implicitly_wait(10)
                                                                    mymodules.Scroll_Down_Small_medium(driver, p_udid,
                                                                                                       index_scroll)

                                                            if facebook_send_message == 1 and not Flag_already_message:
                                                                if counter_Facebook_message < p_quantity_max_message:
                                                                    # =================================================================================
                                                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                                                    # =================================================================================
                                                                    mymodules.PlayStopPause(p_udid,
                                                                                            'Facebook Send message')
                                                                    # =================================================================================
                                                                    # =================================================================================
                                                                    # =================================================================================
                                                                    logger.info(
                                                                        f"{p_udid}|||# =========== IN WHICH ACTIVITY ARE WE? ==========")
                                                                    fb_activity = "com.facebook.katana" + driver.current_activity

                                                                    current_context = driver.current_context
                                                                    contexts = driver.contexts
                                                                    context = driver.context
                                                                    print(50 * "*")
                                                                    print(f"fb_activity : {fb_activity}")
                                                                    print(f"current_context : {current_context}")
                                                                    print(f"contexts : {contexts}")
                                                                    print(f"context : {context}")
                                                                    print(50 * "*")
                                                                    logger.info(
                                                                        f"{p_udid}|||# ======================== WE START TO SEND A MESSAGE TO {fullname} ==========================")
                                                                    logger.info(
                                                                        f"{p_udid}|||# === 1rst We click on button 'message' -----------------------------------------")

                                                                    cpt=0
                                                                    try:
                                                                        message_button = driver.find_element_by_xpath(
                                                                            "//android.view.ViewGroup[@content-desc='Message']")
                                                                        message_button.click()
                                                                        logger.info(
                                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                        time.sleep(random.uniform(0.9, 2.3))
                                                                        driver.implicitly_wait(5)
                                                                    except:
                                                                        cpt+=1
                                                                        if cpt>3:
                                                                            logger.critical(f"{p_udid}|||PhoneBot failed 3 times to find 'send message' button!")
                                                                            break
                                                                        else:
                                                                            GoBackButtonFacebook(driver,p_udid)




                                                                    logger.info(
                                                                        f"{p_udid}|||# === 2nd We click on text field 'message' -----------------------------------------")


                                                                    # === Maybe Messenger is not installed -----------------------------------------------------------
                                                                    # === We will click on messenger button


                                                                    # ---- Before to try to click on text field, let's check if it is a FB page.
                                                                    # --- A FB page will show a button 'GET STARTED' ---------------------------------------
                                                                    try:
                                                                        get_started_button = driver.find_elements_by_xpath(
                                                                            "//android.view.ViewGroup[@content-desc='GET STARTED']")
                                                                        logger.info(
                                                                            f"{p_udid}|||PhoneBot found the English 'Send message' button.")
                                                                        get_started_button[0].click()
                                                                    except:
                                                                        try:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the English 'GET STARTED' button. Let's search for the French one.")
                                                                            get_started_button = driver.find_elements_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='DÉMARRER']")
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot found the French 'Envoyer message' button.")
                                                                            get_started_button[0].click()
                                                                        except:
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot didn't find the French 'DÉMARRER' button. We skip this part")

                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(0.9, 2.3))
                                                                    driver.implicitly_wait(5)


                                                                    # ==============================================================================
                                                                    # Here can come the frame asking to OPEN MESSENGER
                                                                    #LEt's check if this button is here
                                                                    try:
                                                                        open_messenger_button = driver.find_elements_by_xpath (
                                                                            "//android.widget.Button[@text='OPEN MESSENGER' or @text='OUVRIR MESSENGER']")

                                                                        open_messenger_button[0].click ()
                                                                        logger.info (
                                                                            f"{p_udid}|||PhoneBot found the 'OPEN MESSENGER' button.")
                                                                        time.sleep (
                                                                            random.uniform (0.9,2.3))
                                                                        driver.implicitly_wait (5)

                                                                        # ======================================================================
                                                                        # ======================================================================
                                                                        # ======================================================================
                                                                        # === We come back to Facebook because we need to reclick on profile messenger button
                                                                        try:
                                                                            driver.press_keycode (keycode=187)
                                                                            apps_open = driver.find_elements_by_id (
                                                                                "com.android.systemui:id/title")
                                                                            for app_open in apps_open:
                                                                                if app_open.get_attribute (
                                                                                        'content-desc') == 'Facebook':
                                                                                    app_open.click ()

                                                                                    logger.info (
                                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                                    time.sleep (
                                                                                        random.uniform (0.9,
                                                                                                        2.3))
                                                                                    driver.implicitly_wait (5)
                                                                                    break
                                                                        except Exception as ex:
                                                                            logger.info (
                                                                                f"{p_udid}||| {ex} Error when we tried to come back to Facebook")
                                                                        back_messenger_button = driver.find_elements_by_xpath (
                                                                            "//android.view.ViewGroup[@content-desc='Back']")
                                                                        back_messenger_button[0].click ()
                                                                        logger.info (
                                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                        time.sleep (random.uniform (0.9, 2.3))

                                                                        # ======================================================================
                                                                        # ======================================================================
                                                                        # ======================================================================

                                                                    except:
                                                                            logger.info (
                                                                                f"{p_udid}|||PhoneBot didn't find the 'OPEN MESSENGER' button.")




                                                                    # ==============================================================================

                                                                    # =========================================================================================
                                                                    # Now we need to check if Messenger is asking us to select the messenger account?
                                                                    # =========================================================================================
                                                                    try:
                                                                        account_button=driver.find_elements_by_xpath("//androidx.recyclerview.widget.RecyclerView/android.view.ViewGroup/android.widget.FrameLayout/android.view.ViewGroup/android.view.ViewGroup")
                                                                        if len(account_button) !=0:
                                                                            back_messenger_button = driver.find_elements_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='Back']")
                                                                            back_messenger_button[0].click()
                                                                            logger.info(
                                                                                f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                            time.sleep(random.uniform(0.9, 2.3))

                                                                            #It is possible that again the OPEN MESSENGER button is howing up
                                                                            # ==============================================================================
                                                                            # Here can come the frame asking to OPEN MESSENGER
                                                                            # LEt's check if this button is here
                                                                            try:
                                                                                open_messenger_button = driver.find_elements_by_xpath (
                                                                                    "//android.widget.Button[@text='OPEN MESSENGER' or @text='OUVRIR MESSENGER']")

                                                                                open_messenger_button[0].click ()
                                                                                logger.info (
                                                                                    f"{p_udid}|||PhoneBot found the 'OPEN MESSENGER' button.")

                                                                                # ======================================================================
                                                                                # ======================================================================
                                                                                # ======================================================================
                                                                                # And here come another issue: When phonebot click on OPEN MEESENGER,
                                                                                # it doesn't open the send message box to the profile, it open home page
                                                                                # of messenger. We should come back to profile and click again on messenger button
                                                                                # from the profile page

                                                                                current_context = driver.current_context
                                                                                print (f"context : {current_context}")
                                                                                driver.switch_to.context (
                                                                                    current_context)
                                                                                logger.info (
                                                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                                time.sleep (random.uniform (10.2, 15.3))
                                                                                driver.implicitly_wait (15)

                                                                                # === We come back to Facebook
                                                                                try:
                                                                                    driver.press_keycode (keycode=187)
                                                                                    apps_open = driver.find_elements_by_id (
                                                                                        "com.android.systemui:id/title")
                                                                                    for app_open in apps_open:
                                                                                        if app_open.get_attribute('content-desc') == 'Facebook':
                                                                                            app_open.click()
                                                                                            logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                                            time.sleep(random.uniform(0.9, 2.3))
                                                                                            driver.implicitly_wait (5)
                                                                                            break
                                                                                except Exception as ex:
                                                                                    logger.info (
                                                                                        f"{p_udid}||| {ex} Error when we tried to come back to Facebook")
                                                                                back_messenger_button = driver.find_elements_by_xpath (
                                                                                    "//android.view.ViewGroup[@content-desc='Back']")
                                                                                back_messenger_button[0].click ()
                                                                                logger.info (
                                                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                                time.sleep (random.uniform (0.9, 2.3))



                                                                                # ======================================================================
                                                                                # ======================================================================
                                                                                # ======================================================================



                                                                            except:
                                                                                logger.info (
                                                                                    f"{p_udid}|||PhoneBot didn't find the 'OPEN MESSENGER' button.")
                                                                            logger.info (
                                                                                f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                            time.sleep (random.uniform (0.9, 2.3))


                                                                            driver.implicitly_wait(5)
                                                                            logger.info(
                                                                                f"{p_udid}|||# === 2nd click on button 'message' -----------------------------------------")
                                                                            message_button = driver.find_element_by_xpath(
                                                                                "//android.view.ViewGroup[@content-desc='Message']")
                                                                            message_button.click()
                                                                            logger.info(
                                                                                f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                            time.sleep(random.uniform(0.9, 2.3))
                                                                            driver.implicitly_wait(5)
                                                                        else:
                                                                            logger.info(f"{p_udid}||| We didn't find the account button, so that means Facebook is not asking to choose an account before to send a message")

                                                                    except:

                                                                            logger.info(f"{p_udid}||| PhoneBot didn't find the button to select account. Everything seems to be fine to start sending message.")

                                                                    #WebDriverWait finish to test, we can now send the message
                                                                    message_field = driver.find_element_by_class_name(
                                                                        "android.widget.EditText")
                                                                    message_field.click()
                                                                    logger.info(
                                                                        f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                    time.sleep(random.uniform(0.9, 2.3))
                                                                    driver.implicitly_wait(5)

                                                                    logger.info(
                                                                        f"{p_udid}|||# ======================= SENDING MESSAGE =======================================")
                                                                    # === before to send message, we will check if we were not sending a message previously and get interrupted by a bug.

                                                                    logger.info(
                                                                        f"{p_udid}|||# === 1rst, we check if we had a 'message_to_send' row in table actions ===")
                                                                    message_to_send = cursor1.execute(
                                                                        "SELECT message FROM actions WHERE id_contact=? AND platform=? AND type_action=?",
                                                                        (id_contact, 'facebook', 'message_to_send')).fetchone()
                                                                    send_the_message = True

                                                                    if message_to_send:
                                                                        # =================================================================================
                                                                        # =========================== PLAY STOP OR PAUSE ? ================================
                                                                        # =================================================================================
                                                                        mymodules.PlayStopPause(p_udid,
                                                                                                'Facebook Send message')
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        print(
                                                                            f"{p_udid}|||# Phonebot get interrupted while it was sending a message to {fullname} - id : {id_contact}. PhoneBot will continue the message.")
                                                                        print(f"message_to_send: {message_to_send}")
                                                                        print(f"message_to_send[0]: {message_to_send[0]}")

                                                                        # === we check in the history of messages what was the last part of message sent
                                                                        message_already_sent_element = driver.find_elements_by_xpath(
                                                                            "//*[@class='androidx.recyclerview.widget.RecyclerView']/*[@class='android.view.ViewGroup']/*[@class='android.view.ViewGroup']/*[@class='android.view.ViewGroup']/*[@class='android.view.ViewGroup']")
                                                                        print(f"len(message_already_sent_element) : {len(message_already_sent_element)}")
                                                                        imagestring = driver.get_screenshot_as_base64()

                                                                        image_string = io.BytesIO(base64.b64decode(imagestring))
                                                                        image = Image.open(image_string)
                                                                        image.show()

                                                                        message_already_sent = []
                                                                        for element in message_already_sent_element:
                                                                            message_already_sent.append(
                                                                                mymodules.GetTextfromScreenshot(driver, p_udid,
                                                                                                                element))
                                                                            print(
                                                                                f"message_already_sent : {message_already_sent}")
                                                                        list_message_to_send = str(message_to_send[0]).split(
                                                                            "||")
                                                                        print(f"message_already_sent : {message_already_sent}")
                                                                        print(f"list_message_to_send : {list_message_to_send}")
                                                                        print(f"Lenght of list_message_to_send : {len(list_message_to_send)}")

                                                                        # We need to search the last element of message_already_sent and search for it in list_message_to_send
                                                                        if len(message_already_sent) > 1:
                                                                            # =================================================================================
                                                                            # =========================== PLAY STOP OR PAUSE ? ================================
                                                                            # =================================================================================
                                                                            mymodules.PlayStopPause(p_udid,
                                                                                                    'Facebook Send message')
                                                                            # =================================================================================
                                                                            # =================================================================================
                                                                            # =================================================================================
                                                                            pos_index = mymodules.index_of(message_already_sent[
                                                                                                               len(
                                                                                                                   message_already_sent) - 2],
                                                                                                           list_message_to_send)
                                                                            print(f"pos_index : {pos_index}")
                                                                            print(
                                                                                f"message_already_sent[len(message_already_sent) - 2] : {message_already_sent[len(message_already_sent) - 2]}")
                                                                            print(
                                                                                f"list_message_to_send[len(list_message_to_send) - 1] : {list_message_to_send[len(list_message_to_send) - 1]}")
                                                                            if message_already_sent[
                                                                                len(message_already_sent) - 2] == \
                                                                                    list_message_to_send[
                                                                                        len(list_message_to_send) - 1]:
                                                                                print("Message was already sent")
                                                                                send_the_message = False
                                                                            else:
                                                                                if pos_index != -1:
                                                                                    print(
                                                                                        f"PhoneBot found '{message_already_sent[len(message_already_sent) - 2]}' in '{list_message_to_send}'. The index of this part is {pos_index}.")
                                                                                    facebook_msg = ''
                                                                                    for z in range(pos_index + 1,
                                                                                                   len(list_message_to_send)):
                                                                                        facebook_msg += list_message_to_send[
                                                                                                            z] + "||"
                                                                                    send_the_message = True
                                                                                else:
                                                                                    facebook_msg = message_to_send[0]
                                                                                    send_the_message = True
                                                                        else:
                                                                            facebook_msg = message_to_send[0]
                                                                            send_the_message = True

                                                                        print(f"facebook_msg : {facebook_msg}")
                                                                        print(f"send_the_message : {send_the_message}")



                                                                    else:

                                                                        logger.info(
                                                                            f"{p_udid}|||# === We prepare the message which was never sent ----------------------------------")
                                                                        facebook_msg = mymodules.random_abc(facebook_message)

                                                                        # --- Now we have issue with ActionChains and '\n' if we want to write a text with several lines
                                                                        # --- So we will transform the '\n' in '|' and say to our method send_keys_delay_random
                                                                        # to replace the \n by | and make a new line for each |
                                                                        facebook_msg = str(facebook_msg)
                                                                        facebook_msg = facebook_msg.replace('{firstname}',
                                                                                                            firstname).replace('{username}',
                                                                                                            firstname).replace(
                                                                            '\\n',
                                                                            '|').replace(
                                                                            '{group}', facebook_group).replace('{groupe}',
                                                                                                               facebook_group)
                                                                        facebook_msg = html.unescape(unidecode.unidecode(
                                                                            facebook_msg))  # we remove characters with accent
                                                                        # === 2nd, we insert the message to send in table contacts with type = 'message_to_send'
                                                                        now = datetime.now()
                                                                        date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                                        with lock:
                                                                            cursor1.execute("INSERT INTO actions (platform,type_action,date,message,id_smartphone, id_social_account,id_contact,fb_group_name)  VALUES (?,?,?,?,?,?,?,?)",
                                                                                            ('facebook',
                                                                                             'message_to_send', date_n_time,
                                                                                             facebook_msg,
                                                                                             p_udid,
                                                                                             myprofile_username,
                                                                                             id_contact,facebook_group))
                                                                            sqliteConnection.commit()
                                                                    # ================================================================================
                                                                    # ================================================================================
                                                                    # ================================================================================
                                                                    if send_the_message:
                                                                        # =================================================================================
                                                                        # =========================== PLAY STOP OR PAUSE ? ================================
                                                                        # =================================================================================
                                                                        mymodules.PlayStopPause(p_udid,
                                                                                                'Facebook Send message')
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        # =================================================================================
                                                                        logger.info(
                                                                            f"{p_udid}|||# === We type the message ----------------------------------")


                                                                        p_bug=mymodules.SendFacebookMessage(driver, message_field,
                                                                                                     facebook_msg,p_bug, 0.5, 0.75)



                                                                        logger.info(
                                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                        time.sleep(random.uniform(2.2, 4.3))
                                                                        logger.info(
                                                                            f"{p_udid}|||# === 4th We click on 'Send message' button ----------------------")

                                                                        try:
                                                                            send_button = driver.find_elements_by_xpath(
                                                                                "//android.widget.ImageView[@content-desc='Send']")
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot found the English 'Send message' button.")
                                                                            send_button[0].click()
                                                                        except:
                                                                            try:
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot didn't find the English 'Send message' button. Let's search for the French one.")
                                                                                send_button = driver.find_elements_by_xpath(
                                                                                    "//android.widget.ImageView[@content-desc='Envoyer']")
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot found the French 'Envoyer message' button.")
                                                                                send_button[0].click()
                                                                            except:
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot didn't find the French 'Envoyer message' button. We skip this part")
                                                                        if message_to_send:
                                                                            now = datetime.now()
                                                                            date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                                            cursor1.execute(
                                                                                "UPDATE actions set type_action=?, date=? WHERE id_contact=? AND platform=? AND type_action=?",
                                                                                ('message_sent', date_n_time, id_contact,
                                                                                 'facebook', 'message_to_send'))

                                                                            counter_Facebook_message += 1
                                                                        else:

                                                                            logger.info(
                                                                                f"{p_udid}|||# ===========  WE UPDATE DATABASE TO INSERT 'message_sent' IN 'actions' table =========")
                                                                            now = datetime.now()
                                                                            date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                                            with lock:
                                                                                cursor1.execute("INSERT INTO actions (platform,type_action,date,message,id_smartphone,  \
                                                                                                                                id_social_account,id_contact,fb_group_name)  VALUES (?,?,?,?,?,?,?,?)",
                                                                                                ('facebook',
                                                                                                 'message_sent', date_n_time,
                                                                                                 facebook_msg, p_udid,
                                                                                                 myprofile_username,
                                                                                                 id_contact,facebook_group))
                                                                                sqliteConnection.commit()
                                                                                counter_Facebook_message += 1

                                                                    else:
                                                                        now = datetime.now()
                                                                        date_n_time = str(now.strftime("%d/%m/%Y %H:%M:%S"))
                                                                        cursor1.execute(
                                                                            "UPDATE actions set type_action=?, date=? WHERE id_contact=? AND platform=? AND type_action=?",
                                                                            (
                                                                            'message_sent', date_n_time, id_contact, 'facebook',
                                                                            'message_to_send'))

                                                                    logger.info(
                                                                        f"{p_udid}|||# =========== DID WE SWITCH TO 'messenger' APP? ==========")
                                                                    activity = driver.current_activity

                                                                    current_context = driver.current_context
                                                                    contexts = driver.contexts
                                                                    context = driver.context
                                                                    print(50 * "*")
                                                                    print(f"activity : {activity}")
                                                                    print(f"current_context : {current_context}")
                                                                    print(f"contexts : {contexts}")
                                                                    print(f"context : {context}")
                                                                    print(50 * "*")

                                                                    try:
                                                                        cpt_change_app=0
                                                                        logger.info(
                                                                            f"{p_udid}|||PhoneBot was on Messenger App. It will go back to Facebook.")
                                                                        driver.press_keycode(keycode=187)
                                                                        while True:
                                                                            cpt_change_app+=1
                                                                            try:

                                                                                apps_open = driver.find_elements_by_id(
                                                                                    "com.android.systemui:id/title")
                                                                                logger.info(f"{p_udid}|||len(apps_open) : {len(apps_open)}")
                                                                            except:
                                                                                logger.info(f"{p_udid}|||PhoneBot didn't succeed to display the current opened apps. It will tap the 'Switch app' button again")
                                                                                driver.press_keycode(keycode=187)
                                                                                apps_open = driver.find_elements_by_id(
                                                                                    "com.android.systemui:id/title")

                                                                            for app_open in apps_open:
                                                                                if app_open.get_attribute('content-desc') == 'Facebook':
                                                                                    app_open.click()

                                                                                    logger.info(f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                                    time.sleep(random.uniform(0.9, 2.3))
                                                                                    driver.implicitly_wait(5)
                                                                                    break
                                                                            we_are_in_profile = CheckIfWeAreInProfile(
                                                                                driver, p_udid)
                                                                            if we_are_in_profile:
                                                                                break
                                                                            if cpt_change_app>4:
                                                                                break
                                                                    except Exception as ex:
                                                                        logger.info(
                                                                            f"{p_udid}|||{ex} Error when we tried to come back to Facebook")

                                                                        '''
                                                                        try:
        
                                                                            driver.start_activity('com.facebook.katana',
                                                                                                  'com.facebook.groups.memberlist.GroupMemberListHostingActivity')
                                                                            print(
                                                                                "driver.start_activity('com.facebook.katana','com.facebook.groups.memberlist.GroupMemberListHostingActivity')")
                                                                        except:
                                                                            print("Error start_activity. Let's try with presskey")
                                                                            driver.start_activity('com.facebook.katana', fb_activity)
                                                                            print(
                                                                                "driver.start_activity('com.facebook.katana',fb_activity)")
                                                                        '''
                                                                    # ==============================================================================
                                                                    we_are_in_profile = CheckIfWeAreInProfile(driver, p_udid)
                                                                    if not we_are_in_profile:
                                                                        we_are_in_group,title_group,element_group_name = CheckIfWeAreInGroup(driver, p_udid)
                                                                    if we_are_in_group:
                                                                        logger.info(
                                                                            f"{p_udid}|||# === We need to go back to the list of members of the group  ================")
                                                                        elements_of_group = driver.find_elements_by_class_name(
                                                                            "android.view.ViewGroup")

                                                                        # -------------- (3) CHECK THE NAME OF THE GROUP AND IF USER IS MEMBER OF THE GROUP -------------------
                                                                        for element_of_group in elements_of_group:
                                                                            # =================================================================================
                                                                            # =========================== PLAY STOP OR PAUSE ? ================================
                                                                            # =================================================================================
                                                                            mymodules.PlayStopPause(p_udid,
                                                                                                    'Facebook Send message')
                                                                            # =================================================================================
                                                                            # =================================================================================
                                                                            # =================================================================================
                                                                            logger.info(
                                                                                f"{p_udid}|||PhoneBot go in the loop for each element of the group in order to find the name of group and the button 'Join group'.")
                                                                            content_desc = ''
                                                                            try:
                                                                                content_desc = str(
                                                                                    element_of_group.get_attribute(
                                                                                        'content-desc'))
                                                                            except:
                                                                                logger.info(
                                                                                    f"{p_udid}|||There was no 'content-desc' for this element.")
                                                                            if content_desc != '':
                                                                                logger.info(
                                                                                    f"{p_udid}|||content_desc : {content_desc} - {type(content_desc)}")
                                                                                logger.info(
                                                                                    f"{p_udid}|||PhoneBot found some 'content-desc'. Let's compare to '{facebook_group}'.")
                                                                                content_desc = unidecode.unidecode(content_desc)
                                                                                text_fb_group = unidecode.unidecode(
                                                                                    facebook_group)

                                                                                if str(content_desc).find(text_fb_group) != -1:
                                                                                    logger.info(
                                                                                        f"{p_udid}|||content_desc : {content_desc}")
                                                                                    logger.info(
                                                                                        f"{p_udid}|||!!!BINGO!!!PhoneBot is actually in the group '{facebook_group}'.")


                                                                                    break



                                                                else:
                                                                    logger.info(
                                                                        f"{p_udid}|||# PhoneBot reach the maximum limit of sending message : {counter_Facebook_message}/{p_quantity_max_message}")
                                                            else:
                                                                logger.info(
                                                                    f"{p_udid}|||# You didn't activate the option 'Send message to Group member' in 'Account Details' on https://phonebot.co")
                                                                counter_Facebook_message = p_quantity_max_message

                                                            if we_are_in_profile:
                                                                # ==============================================================================================
                                                                # ===================================== GO BACK TO LIST ========================================
                                                                # ==============================================================================================

                                                                logger.info(
                                                                    f"{p_udid}|||# ========================= WE GO BACK TO LIST ======================")

                                                                GoBackButtonFacebook(driver, p_udid)


                                                                logger.info(
                                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                time.sleep(random.uniform(0.9, 2.3))
                                                                driver.implicitly_wait(10)
                                                                GoBackButtonFacebook(driver, p_udid)
                                                                logger.info(
                                                                    f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                                time.sleep(random.uniform(0.9, 2.3))
                                                                driver.implicitly_wait(10)



                                                    else:
                                                        # =================================================================================
                                                        # =========================== PLAY STOP OR PAUSE ? ================================
                                                        # =================================================================================
                                                        mymodules.PlayStopPause(p_udid,
                                                                                'Facebook Send message')
                                                        # =================================================================================
                                                        # =================================================================================
                                                        # =================================================================================
                                                        logger.info(f"{p_udid}|||PhoneBot is in a Facebook Page!")
                                                        # ==============================================================================================
                                                        # ===================================== GO BACK TO LIST ========================================
                                                        # ==============================================================================================
                                                        # === We will add this profile as Facebook page in database in order to skip this profile
                                                        # === directly when scrolling the list of members
                                                        logger.info(
                                                            f"{p_udid}|||'{fullname}' already exist in table 'contacts'. We will update type='fb_page'")
                                                        with lock:
                                                            cursor1.execute("UPDATE contacts set type=? WHERE id=?",
                                                                            ('fb_page', id_contact))
                                                            sqliteConnection.commit()

                                                        logger.info(
                                                            f"{p_udid}|||# ========================= WE GOBACK TO LIST ======================")


                                                        if we_are_in_full_profile:
                                                            GoBackButtonFacebook(driver, p_udid)

                                                            logger.info(
                                                                f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                            time.sleep(random.uniform(0.9, 2.3))
                                                            driver.implicitly_wait(10)

                                                            GoBackButtonFacebook(driver, p_udid)


                                                        else:
                                                            GoBackButtonFacebook(driver, p_udid)

                                                        logger.info(
                                                            f"{p_udid}|||The bot will sleep just a few seconds..............................")
                                                        time.sleep(random.uniform(0.9, 2.3))
                                                        driver.implicitly_wait(10)



                                            else:
                                                logger.info(
                                                    f"{p_udid}|||This user N°{index_member} from displayed list will not get any action")

                                        else:
                                            logger.info(
                                                f"{p_udid}|||This user N°{index_member} is a Facebook page. PhoneBot skip it!")

                                    logger.info(
                                        f"{p_udid}|||AT THE END OF THE PROCESS OF PROFILE=>index_member : {index_member}/{quantity_members - 1}")

                                    logger.info(
                                        f"{p_udid}|||counter_Facebook_add_friend : {counter_Facebook_add_friend}/{p_quantity_max_add_friend}")
                                    logger.info(
                                        f"{p_udid}|||counter_Facebook_message : {counter_Facebook_message}/{p_quantity_max_message}")
                                    logger.info(
                                        f"{p_udid}|||counter_Facebook_scrap : {counter_Facebook_scrap}/{p_quantity_max_scrap}")
                                    if counter_Facebook_add_friend >= p_quantity_max_add_friend and counter_Facebook_message >= p_quantity_max_message and counter_Facebook_scrap >= p_quantity_max_scrap:
                                        break
                                    index_member += 1
                                    cpt_of_members += 1
                                    if index_member >= (quantity_members - 2):
                                        index_member = 1
                                        if not we_are_in_profile:
                                            mymodules.Scroll_Down_Small_medium(driver, p_udid, 2)
                                        else:
                                            index_scroll += 1
                                    logger.info(f"{p_udid}|||index_member : {index_member}")
                                    logger.info(f"{p_udid}|||index_scroll : {index_scroll}")
                                    logger.info(f"{p_udid}|||cpt_of_members : {cpt_of_members}")

                                    if we_are_in_profile:
                                        logger.info(
                                            f"{p_udid}|||PhoneBot was on profile page. So we need to scroll!")
                                        mymodules.Scroll_Down_Small_medium(driver, p_udid, index_scroll)
                                    we_are_in_profile = False

                                    # =================================================================================
                                    # =========================== PLAY STOP OR PAUSE ? ================================
                                    # =================================================================================
                                    mymodules.PlayStopPause(p_udid,
                                                            'Facebook End of loop of scrolling list')
                                    # =================================================================================
                                    # =================================================================================
                                    # =================================================================================

                        else:
                            logger.info(f"{p_udid}|||VERIFICATION 4 FAILED : '{myprofile_username}' is NOT member of '{facebook_group}'")

                    else:
                        logger.info(f"{p_udid}|||VERIFICATION 3 FAILED : group '{facebook_group}' was NOT found!")
                        mymodules.AddActionStatus('Group not fund', p_udid, 'facebook',
                                                                          myprofile_username, fb_group,
                                                                          'You should remove this group from your configuration on http://phonebot.co...',
                                                                          lock)
                else:
                    logger.info(
                        f"{p_udid}|||VERIFICATION 2 FAILED => You didn't fill the textarea 'List of groups' from 'Account details' for facebook account '{myprofile_username}'.")
            else:
                logger.info(
                    f"{p_udid}|||VERIFICATION 1 FAILED => You didn't activate one of the options 'Scrap, Add Friend or Send message to FB group members' from 'Account details' for facebook account '{myprofile_username}'.")

        # ============================================================================================================
        # ============================================================================================================
        # ============================================================================================================

        try:
            if driver:
                driver.quit()
        except:
            logger.error("Phonebot could'nt close the driver.")
        try:
            if cursor1:
                cursor1.close()
        except:
            logger.error("Phonebot could'nt close cursor1.")

        try:
            if sqliteConnection:
                sqliteConnection.close()
        except:
            logger.error("Phonebot could'nt close sqliteConnection.")

    except Exception as ex:

        logger.critical(f"{p_udid}|||{ex} --> Error with Facebook_bot.StartBot()! We try again later.")
    #except ValueError:
        #print("ERROR!!!!!!!")



#
#
# import multiprocessing
#
if __name__ == '__main__':
#     multiprocessing.freeze_support()
#     m = multiprocessing.Manager()
    import threading
    lock = threading.Lock()
    list_arguments_smartphones = []
    StartBot('FACEBOOK', 'OUKIC16PRO37851','4729','C16_Pro_EEA','9.0','Android',0,3,0,3,lock)
    #start_time = time.time()
    #print(f"start_time:{start_time}")
    #StartBot('FACEBOOK', 'A60ProEEA0112572', '4729', 'A60Pro', '9.0', 'Android', 0, 2, 0, 0, lock)
    # end_time = time.time()
    # print(f"start_time:{end_time}")
    # print("-----------------------------")
    # duration = end_time - start_time
    # print(f"Duration : {duration}")
    # StartBot("FACEBOOK ","0123456789ABCDEF","4728","i11", "8.1","Android",2,2,2,2,lock)

